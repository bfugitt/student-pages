<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>System 6 Math Facts - Fact Family</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        /* Base styling */
        body {
            font-family: 'VT323', monospace;
            background-color: #f0f0f0;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 5px; /* Minimal padding for mobile */
            box-sizing: border-box;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #ccc 75%), 
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 4px 4px;
        }

        /* The main application window */
        .window {
            width: 100%;
            max-width: 420px;
            background-color: #fff;
            border: 2px solid #000;
            box-shadow: 6px 6px 0px #000;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            /* Ensure it fits on screen */
            max-height: 98vh; 
            overflow: hidden; 
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100; 
            display: none; 
        }
        
        #confirmation-modal { z-index: 200; }

        .modal-window { max-width: 550px; box-shadow: 10px 10px 0px #000; }
        .alert-window { max-width: 350px; box-shadow: 10px 10px 0px #000; }

        /* Title bar styling */
        .title-bar {
            background-color: #fff;
            border-bottom: 2px solid #000;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .title-bar-stripes {
            flex-grow: 1;
            background-image: repeating-linear-gradient(
                to bottom, #000, #000 2px, #fff 2px, #fff 4px
            );
            height: 14px;
            margin-left: 8px;
            margin-right: 8px;
        }

        .close-box, .pause-box {
            width: 18px;
            height: 18px;
            border: 2px solid #000;
            background: #fff;
            text-align: center;
            line-height: 14px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }
        .close-box:active, .pause-box:active {
            box-shadow: 1px 1px 0px #000;
            transform: translate(1px, 1px);
        }
        .pause-box { margin-left: 4px; font-size: 14px; line-height: 16px; }

        /* --- Top Dashboard Section --- */
        .dashboard {
            border-bottom: 2px solid #000;
            background-color: #f8f8f8;
            padding: 5px;
            flex-shrink: 0;
        }

        /* Info bar (Score and Timer) */
        .info-bar {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            padding: 2px 8px;
            margin-bottom: 5px;
        }

        /* Button styling */
        .button-bar {
            padding: 2px 8px;
            display: flex;
            justify-content: space-between; 
            gap: 5px; 
            margin-bottom: 5px;
        }
        .btn {
            font-family: 'VT323', monospace;
            font-size: 18px; /* Slightly smaller for compact fit */
            background-color: #fff;
            border: 2px solid #000;
            padding: 4px 10px;
            box-shadow: 2px 2px 0px #000;
            cursor: pointer;
            user-select: none;
            flex-grow: 1; /* Stretch buttons */
        }
        .btn:active {
            box-shadow: 1px 1px 0px #000;
            transform: translate(1px, 1px);
        }
        .btn-active-mode {
            background-color: #000;
            color: #fff;
            box-shadow: inset 2px 2px 0px #555;
        }

        /* Mode Selector */
        .mode-selector {
            padding: 2px 8px;
            text-align: center;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #game-mode {
            font-family: 'VT323', monospace;
            font-size: 18px;
            border: 2px solid #000;
            margin-left: 8px;
            padding: 0px;
            background-color: #fff;
        }

        /* --- Main Content Area --- */
        .content {
            padding: 10px;
            text-align: center;
            font-size: 24px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            overflow-y: auto; /* Allow scrolling if really needed */
        }

        /* Layout Container for Problem + Input */
        #active-area {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        /* Layout: Fast Facts (Side-by-Side) */
        #active-area.fast-facts {
            flex-direction: row;
            gap: 10px;
        }
        /* Layout: Triangle (Stacked) */
        #active-area.triangle {
            flex-direction: column;
            gap: 5px;
        }

        /* Problem display */
        #problem-container {
            font-size: 56px; /* Slightly reduced */
            letter-spacing: 2px;
            transition: background-color 0.05s ease-out, color 0.05s ease-out; 
            padding: 0 10px;
        }
        .correction-display {
            background-color: #000 !important; 
            color: #fff !important; 
            transition: none; 
            border-radius: 4px;
        }

        /* Triangle Container */
        #triangle-container {
            position: relative; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 5px auto; 
            height: 140px; /* Reduced height */
            width: 100%; 
            max-width: 280px; 
            box-sizing: border-box;
        }
        
        #triangle-operator-symbol {
            position: absolute;
            top: 60%; 
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 50px; 
            font-weight: bold;
            opacity: 0.3; 
            color: #000;
            z-index: 0; 
            pointer-events: none;
            white-space: nowrap;
        }
        
        #triangle-top-wrapper { margin-bottom: 15px; z-index: 2; }
        #triangle-bottom-row {
            display: flex; justify-content: space-between; width: 100%;
            padding: 0 40px; box-sizing: border-box; z-index: 2; 
        }

        .number-circle {
            width: 60px; height: 60px; /* Smaller circles */
            display: flex; align-items: center; justify-content: center;
            background-color: #eee; border: 2px solid #000;
            border-radius: 50%; box-sizing: border-box; font-size: 32px; z-index: 2;
        }

        /* Input Controls */
        #input-controls {
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 5px;
        }

        #answer-input {
            font-family: 'VT323', monospace;
            font-size: 48px;
            width: 100px;
            text-align: center;
            border: 2px solid #000;
            padding: 2px;
            -moz-appearance: textfield;
        }
        #answer-input:read-only { background-color: #eee; color: #000; }
        #answer-input::-webkit-outer-spin-button,
        #answer-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        #check-answer-btn {
            font-size: 24px;
            padding: 10px 15px;
            height: 56px; /* Match input height roughly */
        }

        #feedback {
            font-size: 20px;
            height: 24px; 
            margin-top: 5px;
            font-weight: bold;
        }
        .feedback-correct { color: #006400; }
        .feedback-incorrect { color: #8b0000; }

        /* --- Footer Areas (Weights / Keypad) --- */
        
        /* Weights display table */
        .weights-container {
            font-size: 16px;
            padding: 5px;
            border-top: 2px solid #000;
            flex-shrink: 0;
            max-height: 150px;
            overflow-y: auto;
        }
        .weights-container h3 { margin: 0 0 5px; text-align: left; font-size: 18px; }
        #weights-table { width: 100%; border-collapse: collapse; text-align: center; }
        #weights-table th, #weights-table td { border: 1px solid #000; padding: 2px; }
        #weights-table th { background-color: #eee; }
        .weight-low { background-color: #c0ffc0; }

        /* Mobile Keypad */
        .keypad-container {
            display: none; 
            padding: 5px;
            border-top: 2px solid #000;
            background-color: #e0e0e0;
            flex-shrink: 0;
        }
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            max-width: 400px;
            margin: 0 auto;
        }
        .keypad-btn {
            font-family: 'VT323', monospace;
            font-size: 28px;
            background-color: #fff;
            border: 2px solid #000;
            padding: 10px 0;
            box-shadow: 2px 2px 0px #000;
            cursor: pointer;
            text-align: center;
            user-select: none;
        }
        .keypad-btn:active {
            box-shadow: 1px 1px 0px #000;
            transform: translate(2px, 2px);
            background-color: #ccc;
        }
        .keypad-enter { font-weight: bold; background-color: #ddd; }

        /* Log Table styling */
        #log-list-container { max-height: 200px; overflow-y: auto; border: 1px solid #000; margin-bottom: 20px; padding: 5px; background: #fff; }
        #log-table { width: 100%; border-collapse: collapse; font-size: 18px; }
        #log-table th, #log-table td { text-align: left; padding: 4px; border-bottom: 1px solid #ccc; }
        #log-table th { border-bottom: 2px solid #000; }

    </style>
</head>
<body>

    <!-- MODAL: Practice Log -->
    <div id="history-modal" class="modal-overlay">
        <div class="window modal-window">
            <div class="title-bar">
                <div class="close-box" id="modal-close-box">&times;</div>
                <div class="title-bar-stripes"></div>
                <div>Practice Log</div>
                <div class="title-bar-stripes"></div>
            </div>
            <div class="content" style="padding-bottom: 0;">
                <div id="log-list-container">
                    <table id="log-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Mode</th>
                                <th>Score</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body"></tbody>
                    </table>
                </div>
                <div style="margin-bottom: 15px; font-size: 18px;">
                    Select an action below:
                </div>
            </div>
            <div class="button-bar" style="justify-content: space-between; padding-top: 0;">
                <button class="btn" id="btn-continue">Continue</button>
                <button class="btn" id="btn-new-session">New Session</button>
                <button class="btn" id="btn-reset-all" style="background-color: #ffebeb;">Reset All</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Confirmation Alert -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="window alert-window">
            <div class="title-bar">
                <div class="close-box" id="confirm-close-box">&times;</div>
                <div class="title-bar-stripes"></div>
                <div>Alert</div>
                <div class="title-bar-stripes"></div>
            </div>
            <div class="content">
                <div id="confirmation-message" style="margin-bottom: 20px;"></div>
                <div class="button-bar" style="justify-content: center; gap: 20px; padding: 0;">
                    <button class="btn" id="btn-confirm-yes">Yes</button>
                    <button class="btn" id="btn-confirm-cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main application window -->
    <div class="window">
        <!-- Title bar -->
        <div class="title-bar">
            <div class="close-box" id="close-box-btn">&times;</div>
            <div class="title-bar-stripes"></div>
            <div>System 6 Math Facts</div>
            <div class="title-bar-stripes"></div>
            <div class="pause-box" id="pause-box-btn">||</div>
        </div>

        <!-- NEW Dashboard Section at the top -->
        <div class="dashboard">
            <!-- Stats Row -->
            <div class="info-bar">
                <div id="score">Score: 0</div>
                <div id="total-time">Time: 00:00</div>
            </div>

            <!-- Controls Row -->
            <div class="button-bar">
                <button class="btn" id="keypad-toggle-btn">Keypad</button>
                <button class="btn" id="log-btn">Log</button>
                <button class="btn" id="reset-btn">Reset</button>
            </div>

            <!-- Mode Selector Row -->
            <div class="mode-selector">
                <label for="game-mode">Mode:</label>
                <select id="game-mode">
                    <option value="fastFacts">Fast Facts (Mixed)</option>
                    <option value="factFamilyAddSub">Fact Family (+ / -)</option>
                    <option value="factFamilyMulDiv">Fact Family (× / ÷)</option>
                </select>
            </div>
        </div>

        <!-- Main content area -->
        <div class="content">
            
            <!-- Active Area: Contains Problem and Input -->
            <div id="active-area" class="fast-facts">
                
                <!-- 1. The Problem (Text or Triangle) -->
                <div id="problem-container">
                    7 &times; 6 =
                </div>
                
                <div id="triangle-container" style="display: none;">
                    <div id="triangle-operator-symbol"></div> 
                    <div class="triangle-row" id="triangle-top-wrapper">
                        <div class="number-circle" id="triangle-top"></div>
                    </div>
                    <div class="triangle-row" id="triangle-bottom-row">
                        <div class="number-circle" id="triangle-bottom-left"></div>
                        <div class="number-circle" id="triangle-bottom-right"></div>
                    </div>
                </div>

                <!-- 2. The Input Box -->
                <div id="input-controls">
                    <input type="number" id="answer-input" inputmode="numeric" pattern="[0-9]*">
                    <!-- Manual Enter Button (Only shown if Keypad is OFF) -->
                    <button class="btn" id="check-answer-btn">Check</button>
                </div>

            </div>

            <!-- Feedback message -->
            <div id="feedback">
                Enter your answer.
            </div>
        </div>

        <!-- Footer Area: Weights OR Keypad -->
        <div class="weights-container" id="weights-container">
            <h3>Number Weights</h3>
            <table id="weights-table">
                <thead>
                    <tr id="weights-header-row">
                        <th>Num</th>
                        <th>+ / -</th>
                        <th>&times; / &divide;</th>
                    </tr>
                </thead>
                <tbody id="weights-body"></tbody>
            </table>
        </div>
        
        <div class="keypad-container" id="keypad-container">
            <div class="keypad-grid">
                <div class="keypad-btn" onclick="keypadPress(7)">7</div>
                <div class="keypad-btn" onclick="keypadPress(8)">8</div>
                <div class="keypad-btn" onclick="keypadPress(9)">9</div>
                
                <div class="keypad-btn" onclick="keypadPress(4)">4</div>
                <div class="keypad-btn" onclick="keypadPress(5)">5</div>
                <div class="keypad-btn" onclick="keypadPress(6)">6</div>
                
                <div class="keypad-btn" onclick="keypadPress(1)">1</div>
                <div class="keypad-btn" onclick="keypadPress(2)">2</div>
                <div class="keypad-btn" onclick="keypadPress(3)">3</div>
                
                <div class="keypad-btn" onclick="keypadBackspace()">&lt;</div>
                <div class="keypad-btn" onclick="keypadPress(0)">0</div>
                <div class="keypad-btn keypad-enter" onclick="checkAnswer()">OK</div>
            </div>
        </div>
    </div>

    <script>
        // --- Constants ---
        const LOCAL_STORAGE_KEY = 'system6MathFactsState';
        const TIME_LIMIT_SECONDS = 3.0; 
        const INITIAL_OPERAND_WEIGHT = 5; 
        const WEIGHT_CHANGE_AMOUNT = 1;   
        const MIN_WEIGHT = 1;
        const MAX_WEIGHT = 10;
        const NEXT_PROBLEM_DELAY_MS = 300; 
        const CORRECTION_DISPLAY_DURATION_MS = 900; 

        // --- Game Range Settings ---
        const INITIAL_MIN_NUM = 2;
        const INITIAL_MAX_NUM = 9;
        const MASTER_MIN_NUM = 2;
        const MASTER_MAX_NUM = 20;

        // --- Game State Variables ---
        let currentScore = 0;
        let operandWeights = { addSub: {}, mulDiv: {} };
        let currentProblem = {};
        let lastProblemKey = ""; 
        let startTime = 0;
        let timerInterval = null; 
        let totalTimeSeconds = 0; 
        let totalTimeInterval = null; 
        let isPaused = false; 
        let currentMode = 'fastFacts'; 
        let practiceLogs = []; 
        let isMobileKeypadActive = false; 
        
        let pendingConfirmationAction = null;

        let minNumActive = INITIAL_MIN_NUM; 
        let maxNumAddSub = INITIAL_MAX_NUM;
        let maxNumMulDiv = INITIAL_MAX_NUM;

        // --- DOM Elements ---
        const activeArea = document.getElementById('active-area'); // New Container
        const problemContainer = document.getElementById('problem-container');
        const triangleContainer = document.getElementById('triangle-container'); 
        const answerInput = document.getElementById('answer-input');
        const feedback = document.getElementById('feedback');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('total-time'); // Changed ref
        const resetBtn = document.getElementById('reset-btn'); 
        const logBtn = document.getElementById('log-btn'); 
        const keypadToggleBtn = document.getElementById('keypad-toggle-btn'); 
        const weightsTableBody = document.getElementById('weights-body');
        const modeSelector = document.getElementById('game-mode'); 
        
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const closeBoxBtn = document.getElementById('close-box-btn');
        const pauseBoxBtn = document.getElementById('pause-box-btn'); 
        
        const weightsContainer = document.getElementById('weights-container');
        const keypadContainer = document.getElementById('keypad-container');

        const triangleTop = document.getElementById('triangle-top');
        const triangleBottomLeft = document.getElementById('triangle-bottom-left');
        const triangleBottomRight = document.getElementById('triangle-bottom-right');
        const triangleOperatorSymbol = document.getElementById('triangle-operator-symbol');

        const historyModal = document.getElementById('history-modal');
        const modalCloseBox = document.getElementById('modal-close-box');
        const btnContinue = document.getElementById('btn-continue');
        const btnNewSession = document.getElementById('btn-new-session');
        const btnResetAll = document.getElementById('btn-reset-all');
        const logTableBody = document.getElementById('log-table-body');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const btnConfirmYes = document.getElementById('btn-confirm-yes');
        const btnConfirmCancel = document.getElementById('btn-confirm-cancel');
        const confirmCloseBox = document.getElementById('confirm-close-box');


        // === Game Logic ===

        function loadGameState() {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    currentScore = state.currentScore || 0;
                    minNumActive = state.minNumActive || INITIAL_MIN_NUM;
                    maxNumAddSub = Math.min(MASTER_MAX_NUM, state.maxNumAddSub || state.currentMaxNum || INITIAL_MAX_NUM);
                    maxNumMulDiv = Math.min(MASTER_MAX_NUM, state.maxNumMulDiv || state.currentMaxNum || INITIAL_MAX_NUM);
                    operandWeights = state.operandWeights;
                    lastProblemKey = state.lastProblemKey || "";
                    totalTimeSeconds = state.totalTimeSeconds || 0; 
                    currentMode = state.currentMode || 'fastFacts'; 
                    practiceLogs = state.practiceLogs || []; 
                    isMobileKeypadActive = state.isMobileKeypadActive || false; 
                    
                    ensureWeightsExist();
                } catch (e) {
                    console.error("Could not parse saved state, starting new game.", e);
                    initializeNewGame();
                }
            } else {
                initializeNewGame();
            }
            
            modeSelector.value = currentMode; 
            applyKeypadMode();
            updateScoreDisplay();
            updateTotalTimeDisplay(); 
            updateWeightTable();
            startTotalTimeInterval(); 
            nextProblem();
        }
        
        function initializeNewGame() {
            currentScore = 0;
            minNumActive = INITIAL_MIN_NUM;
            maxNumAddSub = INITIAL_MAX_NUM;
            maxNumMulDiv = INITIAL_MAX_NUM;
            operandWeights = { addSub: {}, mulDiv: {} };
            lastProblemKey = "";
            totalTimeSeconds = 0; 
            isPaused = false;
            currentMode = 'fastFacts'; 
            practiceLogs = [];
            isMobileKeypadActive = false;
            ensureWeightsExist();
        }
        
        function ensureWeightsExist() {
            for (let i = minNumActive; i <= maxNumAddSub; i++) {
                if (!operandWeights.addSub[i]) {
                    operandWeights.addSub[i] = INITIAL_OPERAND_WEIGHT;
                }
            }
            for (let i = minNumActive; i <= maxNumMulDiv; i++) {
                if (!operandWeights.mulDiv[i]) {
                    operandWeights.mulDiv[i] = INITIAL_OPERAND_WEIGHT;
                }
            }
        }

        function saveGameState() {
            const state = {
                currentScore,
                minNumActive,
                maxNumAddSub,
                maxNumMulDiv,
                operandWeights,
                lastProblemKey,
                totalTimeSeconds,
                currentMode,
                practiceLogs,
                isMobileKeypadActive 
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
        }
        
        function toggleKeypad() {
            isMobileKeypadActive = !isMobileKeypadActive;
            applyKeypadMode();
            saveGameState();
        }
        
        function applyKeypadMode() {
            if (isMobileKeypadActive) {
                weightsContainer.style.display = 'none';
                keypadContainer.style.display = 'block';
                keypadToggleBtn.classList.add('btn-active-mode'); 
                
                answerInput.readOnly = true; // Use readOnly, not disabled, so it can still show value
                checkAnswerBtn.style.display = 'none';
                
            } else {
                weightsContainer.style.display = 'block';
                keypadContainer.style.display = 'none';
                keypadToggleBtn.classList.remove('btn-active-mode');
                
                answerInput.readOnly = false;
                checkAnswerBtn.style.display = 'inline-block';
            }
        }
        
        window.keypadPress = function(num) {
            if (answerInput.disabled) return;
            if (answerInput.value.length < 4) {
                answerInput.value += num;
            }
        };
        
        window.keypadBackspace = function() {
            if (answerInput.disabled) return;
            answerInput.value = answerInput.value.slice(0, -1);
        };

        function logScore() {
            if (!isPaused) togglePause();

            const now = new Date();
            const logEntry = {
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                score: Math.floor(currentScore),
                duration: formatTime(totalTimeSeconds),
                mode: getModeDisplayName(currentMode) 
            };

            practiceLogs.unshift(logEntry);
            saveGameState(); 
            
            renderLogs();
            historyModal.style.display = 'flex'; 
        }
        
        function getModeDisplayName(mode) {
            if (mode === 'factFamilyAddSub') return 'Family (+/-)';
            if (mode === 'factFamilyMulDiv') return 'Family (×/÷)';
            return 'Fast Facts'; 
        }

        function renderLogs() {
            logTableBody.innerHTML = '';
            practiceLogs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.date}</td>
                    <td>${log.mode || '-'}</td>
                    <td>${log.score}</td>
                    <td>${log.duration}</td>
                `;
                logTableBody.appendChild(row);
            });
        }

        function showConfirmation(message, onConfirmAction) {
            confirmationMessage.textContent = message;
            pendingConfirmationAction = onConfirmAction;
            confirmationModal.style.display = 'flex';
        }

        function hideConfirmation() {
            confirmationModal.style.display = 'none';
            pendingConfirmationAction = null;
        }

        btnConfirmYes.addEventListener('click', () => {
            if (pendingConfirmationAction) {
                pendingConfirmationAction();
            }
            hideConfirmation();
        });

        btnConfirmCancel.addEventListener('click', hideConfirmation);
        confirmCloseBox.addEventListener('click', hideConfirmation);

        function actionContinue() {
            historyModal.style.display = 'none';
            if (isPaused) togglePause(); 
        }

        function actionNewSession() {
            stopTimerDisplay();
            stopTotalTimeInterval();

            currentScore = 0;
            totalTimeSeconds = 0;
            
            saveGameState();
            
            updateScoreDisplay();
            updateTotalTimeDisplay();
            historyModal.style.display = 'none';
            feedback.textContent = "New Session Started!";
            
            if (isPaused) {
                isPaused = false;
                pauseBoxBtn.textContent = '||';
                startTotalTimeInterval();
                nextProblem();
            } else {
                startTotalTimeInterval();
                nextProblem();
            }
        }

        function actionResetAll() {
            showConfirmation("Are you sure you want to reset all scores and log entries?", () => {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                initializeNewGame(); 
                saveGameState();     
                
                modeSelector.value = currentMode; 
                applyKeypadMode(); 
                updateScoreDisplay();
                updateTotalTimeDisplay(); 
                updateWeightTable();
                
                historyModal.style.display = 'none';
                feedback.textContent = "Full Reset Complete.";
                
                if (isPaused) {
                    isPaused = false;
                    pauseBoxBtn.textContent = '||';
                }
                startTotalTimeInterval();
                nextProblem();
            });
        }

        function resetGame() {
            stopTimerDisplay(); 
            stopTotalTimeInterval(); 
            
            showConfirmation("Are you sure? This will reset your level progress, score, and time.", () => {
                const existingLogs = [...practiceLogs]; 
                const keypadPref = isMobileKeypadActive;
                
                initializeNewGame(); 
                
                practiceLogs = existingLogs; 
                isMobileKeypadActive = keypadPref; 
                
                saveGameState();
                modeSelector.value = currentMode;
                applyKeypadMode(); 
                updateScoreDisplay();
                updateTotalTimeDisplay();
                updateWeightTable();
                feedback.textContent = "Progress reset.";
                feedback.className = '';
                
                startTotalTimeInterval();
                nextProblem();
            });
            
            if (!isPaused) {
                startTimerDisplay();
                startTotalTimeInterval();
            }
        }
        
        function createWeightedList(weights, maxNum) {
            const list = [];
            for (let i = minNumActive; i <= maxNum; i++) {
                const weight = weights[i] || INITIAL_OPERAND_WEIGHT; 
                for (let j = 0; j < weight; j++) {
                    list.push(i.toString());
                }
            }
            return list;
        }

        function selectRandomFromList(list) {
            if (list.length === 0) return null;
            const index = Math.floor(Math.random() * list.length);
            return list[index];
        }

        function updateProblemDisplay() {
            problemContainer.classList.remove('correction-display'); 
            problemContainer.textContent = ''; 
            triangleOperatorSymbol.textContent = ''; 

            const isFactFamily = currentMode.startsWith('factFamily');

            // Reset layout classes
            activeArea.className = isFactFamily ? 'triangle' : 'fast-facts';

            if (isFactFamily && currentProblem.triangle) {
                problemContainer.style.display = 'none';
                triangleContainer.style.display = 'flex';
                
                const { numA, numB, numC, missingIndex, isAddSub } = currentProblem.triangle;
                
                triangleTop.textContent = missingIndex === 2 ? '?' : numC;
                triangleBottomLeft.textContent = missingIndex === 0 ? '?' : numA;
                triangleBottomRight.textContent = missingIndex === 1 ? '?' : numB;

                triangleOperatorSymbol.textContent = isAddSub ? '+/-' : '×/÷';

            } else { 
                problemContainer.style.display = 'block';
                triangleContainer.style.display = 'none';
                // Show question with = to prompt for answer
                problemContainer.textContent = `${currentProblem.num1} ${currentProblem.op} ${currentProblem.num2} =`;
            }
        }

        function nextProblem() {
            if (isPaused) return;

            let num1, num2, op;
            let validProblemFound = false;
            let attempts = 0;

            while (!validProblemFound && attempts < 15) {
                attempts++;
                
                let isAddSubMode = false;
                let isMulDivMode = false;
                
                if (currentMode === 'factFamilyAddSub') isAddSubMode = true;
                else if (currentMode === 'factFamilyMulDiv') isMulDivMode = true;
                else {
                    if (Math.random() < 0.5) isAddSubMode = true;
                    else isMulDivMode = true;
                }

                if (currentMode.startsWith('factFamily')) {
                    const isAddSub = isAddSubMode; 
                    const maxNum = isAddSub ? maxNumAddSub : maxNumMulDiv;
                    const weightPool = createWeightedList(isAddSub ? operandWeights.addSub : operandWeights.mulDiv, maxNum);
                    
                    if (weightPool.length < 2) continue; 

                    let numA = parseInt(selectRandomFromList(weightPool));
                    let numB = parseInt(selectRandomFromList(weightPool));
                    let numC;

                    if (numA > numB) [numA, numB] = [numB, numA];

                    if (isAddSub) {
                        numC = numA + numB;
                        if (numC > MASTER_MAX_NUM * 2) continue; 
                    } else {
                        numC = numA * numB;
                        if (numC > 144) continue; 
                    }

                    const missingIndex = Math.floor(Math.random() * 3); 
                    
                    let baseOp, numMain, numSecondary, answerVal;

                    if (missingIndex === 0) {
                        baseOp = isAddSub ? '-' : '÷';
                        numMain = numC; numSecondary = numB; answerVal = numA;
                    } else if (missingIndex === 1) {
                        baseOp = isAddSub ? '-' : '÷';
                        numMain = numC; numSecondary = numA; answerVal = numB;
                    } else { 
                        baseOp = isAddSub ? '+' : 'x';
                        numMain = numA; numSecondary = numB; answerVal = numC;
                    }

                    currentProblem = { 
                        num1: numMain, 
                        num2: numSecondary, 
                        op: baseOp, 
                        answer: answerVal,
                        triangle: { numA, numB, numC, missingIndex, isAddSub }
                    };
                } 
                
                else {
                    const ops = isAddSubMode ? ['+', '-'] : ['x', '÷'];
                    op = ops[Math.floor(Math.random() * ops.length)];
                    
                    let weightPool, maxNum;
                    if (isAddSubMode) {
                        maxNum = maxNumAddSub;
                        weightPool = createWeightedList(operandWeights.addSub, maxNum);
                    } else {
                        maxNum = maxNumMulDiv;
                        weightPool = createWeightedList(operandWeights.mulDiv, maxNum);
                    }
                    
                    if (weightPool.length === 0) continue;

                    num1 = parseInt(selectRandomFromList(weightPool));
                    num2 = parseInt(selectRandomFromList(weightPool));
                    
                    if (op === '÷') {
                        const product = num1 * num2;
                        if (product > 99 || product === 0 || num2 < minNumActive) continue; 
                        const answer = num1; 
                        num1 = product;
                        if(answer < minNumActive || answer > maxNum) continue; 
                        currentProblem = { num1, num2, op, answer };
                    } else if (op === '-') {
                        if (num1 < num2) [num1, num2] = [num2, num1]; 
                        currentProblem = { num1, num2, op, answer: num1 - num2 };
                    } else if (op === '+') {
                        currentProblem = { num1, num2, op, answer: num1 + num2 };
                    } else if (op === 'x') {
                        currentProblem = { num1, num2, op, answer: num1 * num2 };
                    }
                }
                
                const tempKey = `${currentProblem.num1}${currentProblem.op}${currentProblem.num2}`;
                if (tempKey !== lastProblemKey) {
                    validProblemFound = true;
                }
            }
            
            if (!currentProblem.op) {
                 currentProblem = { num1: 2, num2: 2, op: '+', answer: 4, triangle: null };
            }

            lastProblemKey = `${currentProblem.num1}${currentProblem.op}${currentProblem.num2}`;

            updateProblemDisplay(); 
            
            answerInput.value = '';
            
            // Only focus if keypad is NOT active to avoid jumping on mobile
            if (!isMobileKeypadActive) {
                answerInput.focus();
            }
            
            startTimerDisplay();
            startTime = Date.now();
        }

        function checkAnswer() {
            if (isPaused) return;
            
            stopTimerDisplay();
            const answerTime = (Date.now() - startTime) / 1000.0;
            const userAnswer = parseInt(answerInput.value);

            if (isNaN(userAnswer)) {
                feedback.textContent = "Please enter a number.";
                feedback.className = 'feedback-incorrect';
                startTimerDisplay(); 
                return;
            }

            const isCorrect = (userAnswer === currentProblem.answer);
            const isFast = (answerTime <= TIME_LIMIT_SECONDS);
            
            let baseScore;
            if (currentMode.startsWith('factFamily') && currentProblem.triangle) {
                 baseScore = (currentProblem.triangle.numA + currentProblem.triangle.numB) / 2;
            } else {
                 baseScore = (currentProblem.num1 + currentProblem.num2) / 2;
            }

            let scoreChange = 0;

            if (isCorrect) {
                if (isFast) {
                    feedback.textContent = `Correct! (${answerTime.toFixed(1)}s)`;
                    feedback.className = 'feedback-correct';
                    scoreChange = Math.max(2, baseScore); 
                    adjustWeights(currentProblem, false); 
                } else {
                    feedback.textContent = `Correct, but slow. (${answerTime.toFixed(1)}s)`;
                    feedback.className = 'feedback-correct';
                    scoreChange = Math.max(1, baseScore / 2); 
                }
            } else {
                feedback.textContent = `Incorrect. The answer was ${currentProblem.answer}.`;
                feedback.className = 'feedback-incorrect';
                scoreChange = -Math.max(1, baseScore / 4); 
                adjustWeights(currentProblem, true); 
            }

            currentScore = Math.max(0, currentScore + scoreChange);
            updateScoreDisplay();
            
            const opType = (currentProblem.op === '+' || currentProblem.op === '-') ? 'addSub' : 'mulDiv';
            checkMaxNumProgression(opType);

            updateWeightTable();
            saveGameState();
            
            if (isCorrect) {
                setTimeout(nextProblem, NEXT_PROBLEM_DELAY_MS); 
            } else {
                displayCorrection(currentProblem);
            }
        }
        
        function displayCorrection(problem) {
            let correctEquation;
            if (currentMode.startsWith('factFamily') && problem.triangle) {
                const { numA, numB, numC } = problem.triangle;
                correctEquation = `${numA} ${problem.triangle.isAddSub ? '+' : '×'} ${numB} = ${numC}`;
            } else {
                correctEquation = `${problem.num1} ${problem.op} ${problem.num2} = ${problem.answer}`;
            }
            
            answerInput.disabled = true;
            // Note: Don't blur here if keypad active, it might cause weird jumps.
            // But we do want to disable interaction.
            if (!isMobileKeypadActive) answerInput.blur();

            const flashTarget = document.getElementById('problem-container');
            
            flashTarget.style.display = 'block';
            document.getElementById('triangle-container').style.display = 'none';

            flashTarget.classList.add('correction-display');
            flashTarget.textContent = correctEquation;

            setTimeout(() => {
                flashTarget.classList.remove('correction-display');
                answerInput.disabled = false;
                setTimeout(nextProblem, NEXT_PROBLEM_DELAY_MS);
            }, CORRECTION_DISPLAY_DURATION_MS);
        }

        function adjustWeights(problem, increase) {
            const change = increase ? WEIGHT_CHANGE_AMOUNT : -WEIGHT_CHANGE_AMOUNT;
            let weightsToAdjust = [];
            let weightPool;
            let opType;

            if (currentMode.startsWith('factFamily') && problem.triangle) {
                const { numA, numB, isAddSub } = problem.triangle;
                opType = isAddSub ? 'addSub' : 'mulDiv';
                weightPool = isAddSub ? operandWeights.addSub : operandWeights.mulDiv;
                weightsToAdjust = [numA, numB];
            } else {
                const { num1, num2, op, answer } = problem;
                opType = (op === '+' || op === '-') ? 'addSub' : 'mulDiv';
                weightPool = opType === 'addSub' ? operandWeights.addSub : operandWeights.mulDiv;
                weightsToAdjust = [num1, num2];
                if (op === '÷') {
                    weightsToAdjust.push(answer);
                }
            }

            weightsToAdjust.forEach(num => {
                if (num >= MASTER_MIN_NUM && num <= MASTER_MAX_NUM) {
                     if (weightPool[num] !== undefined) {
                         weightPool[num] = Math.max(MIN_WEIGHT, Math.min(MAX_WEIGHT, weightPool[num] + change));
                     }
                }
            });
        }
        
        function checkMaxNumProgression(operationType) {
            const isAddSub = (operationType === 'addSub');
            let currentMax = isAddSub ? maxNumAddSub : maxNumMulDiv;
            const weightPool = isAddSub ? operandWeights.addSub : operandWeights.mulDiv;
            
            if (currentMax < MASTER_MAX_NUM && weightPool[currentMax] === MIN_WEIGHT) {
                currentMax++;
                if (isAddSub) {
                    maxNumAddSub = currentMax;
                } else {
                    maxNumMulDiv = currentMax;
                }
                ensureWeightsExist();
                feedback.textContent = `Level Up! Unlocked facts for ${currentMax} in ${operationType === 'addSub' ? 'Add/Sub' : 'Mult/Div'}!`;
                feedback.className = 'feedback-correct';
                return true;
            }
            return false;
        }

        function startTimerDisplay() {
            stopTimerDisplay(); 
            // We use Date.now() for accurate elapsed time, but we also want a visual timer
            // Since we aren't showing per-problem timer visually in the new layout, this interval basically just tracks state?
            // Actually the prompt said "Time: 0.0s" in info bar is Total Time now. 
            // We can remove the per-problem visual update to save resources if it's not shown.
            // But we NEED the interval to stop so we can restart it. 
            // Let's just keep the interval variable management but not update DOM if element is gone.
            // Wait, the new layout has Total Time: 00:00. It doesn't show the 3.0s countdown.
            // So we don't need to update DOM here.
        }

        function stopTimerDisplay() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function startTotalTimeInterval() {
            if (!totalTimeInterval) {
                totalTimeInterval = setInterval(() => {
                    totalTimeSeconds++;
                    updateTotalTimeDisplay();
                }, 1000); 
            }
        }

        function stopTotalTimeInterval() {
            if (totalTimeInterval) {
                clearInterval(totalTimeInterval);
                totalTimeInterval = null;
            }
            saveGameState(); 
        }
        
        function formatTime(totalSec) {
            const minutes = Math.floor(totalSec / 60);
            const seconds = totalSec % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(seconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }

        function updateTotalTimeDisplay() {
            // Note: In new layout, timerDisplay variable points to #total-time
            timerDisplay.textContent = `Time: ${formatTime(totalTimeSeconds)}`;
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = `Score: ${Math.floor(currentScore)}`;
        }

        function updateWeightTable() {
            const overallMax = Math.max(maxNumAddSub, maxNumMulDiv);
            const weightsHeaderRow = document.getElementById('weights-header-row');
            
            weightsHeaderRow.innerHTML = `
                <th>Num</th>
                <th>+ / -</th>
                <th>&times; / &divide;</th>
            `;
            weightsTableBody.innerHTML = ""; 

            for (let i = minNumActive; i <= overallMax; i++) {
                const row = document.createElement('tr');
                const addSubActive = i <= maxNumAddSub;
                const mulDivActive = i <= maxNumMulDiv;

                const addSubWeight = addSubActive ? (operandWeights.addSub[i] || INITIAL_OPERAND_WEIGHT) : 'N/A';
                const mulDivWeight = mulDivActive ? (operandWeights.mulDiv[i] || INITIAL_OPERAND_WEIGHT) : 'N/A';
                
                const addSubClass = addSubActive && addSubWeight === MIN_WEIGHT ? 'weight-low' : '';
                const mulDivClass = mulDivActive && mulDivWeight === MIN_WEIGHT ? 'weight-low' : '';


                row.innerHTML = `
                    <td>${i}</td>
                    <td class="${addSubClass}">${addSubWeight}</td>
                    <td class="${mulDivClass}">${mulDivWeight}</td>
                `;
                weightsTableBody.appendChild(row);
            }
        }

        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        
        checkAnswerBtn.addEventListener('click', checkAnswer);
        closeBoxBtn.addEventListener('click', cancelProblem);
        pauseBoxBtn.addEventListener('click', togglePause);
        resetBtn.addEventListener('click', resetGame);
        logBtn.addEventListener('click', logScore); 
        keypadToggleBtn.addEventListener('click', toggleKeypad);

        btnContinue.addEventListener('click', actionContinue);
        btnNewSession.addEventListener('click', actionNewSession);
        btnResetAll.addEventListener('click', actionResetAll);
        modalCloseBox.addEventListener('click', actionContinue);
        
        btnConfirmYes.addEventListener('click', () => {
            if (pendingConfirmationAction) pendingConfirmationAction();
            hideConfirmation();
        });
        btnConfirmCancel.addEventListener('click', hideConfirmation);
        confirmCloseBox.addEventListener('click', hideConfirmation);
        
        modeSelector.addEventListener('change', (e) => {
            currentMode = e.target.value;
            stopTimerDisplay();
            stopTotalTimeInterval();
            currentScore = 0;
            totalTimeSeconds = 0;
            saveGameState(); 
            updateScoreDisplay();
            updateTotalTimeDisplay();
            feedback.textContent = "Mode Changed: New Session Started!";
            if (isPaused) {
                isPaused = false;
                pauseBoxBtn.textContent = '||';
            }
            startTotalTimeInterval();
            nextProblem();    
        });

        function togglePause() {
            if (isPaused) {
                isPaused = false;
                pauseBoxBtn.textContent = '||';
                startTotalTimeInterval(); 
                updateTotalTimeDisplay(); 
                feedback.textContent = "Resumed. Get ready!";
                feedback.className = '';
                setTimeout(nextProblem, 50); 
            } else {
                isPaused = true;
                stopTimerDisplay(); 
                stopTotalTimeInterval(); 
                document.getElementById('problem-container').style.display = 'block'; 
                document.getElementById('triangle-container').style.display = 'none';
                problemContainer.textContent = '- PAUSED -';
                problemContainer.classList.remove('correction-display');
                answerInput.value = '';
                if(!isMobileKeypadActive) answerInput.blur();
                pauseBoxBtn.textContent = '▶';
                feedback.textContent = "Game Paused";
                feedback.className = '';
                timerDisplay.textContent = "Time: PAUSED";
            }
        }
        
        function cancelProblem() {
            if (isPaused) return;
            stopTimerDisplay();
            answerInput.value = '';
            feedback.textContent = "Problem skipped. Loading next one...";
            feedback.className = '';
            nextProblem();
        }

        window.addEventListener('beforeunload', saveGameState); 
        loadGameState();

    </script>
</body>
</html>
