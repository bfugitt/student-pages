<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Web Synth Sequencer (16 Steps, C Major) with ADSR SVG</title>
    <style>
        /* ... (Keep all existing CSS styles) ... */
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
        }
        /* Synth and Global Controls Layout */
        #synth-controls, .controls {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #synth-controls {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            align-items: center;
        }
        .control-group {
            text-align: left;
        }
        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            font-size: 12px;
        }
        input[type="range"] {
            width: 100%;
        }
        /* Sequencer Controls */
        .controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }
        #play-button { background-color: #4CAF50; color: white; }
        #play-button.playing { background-color: #f39c12; }
        #clear-button { background-color: #333; color: white; }
        #audio-init-button { background-color: #64b5f6; color: white; }

        /* Grid CSS - Simplified */
        .grid-wrapper {
            display: flex;
            margin-top: 15px;
            border: 1px solid #ccc;
        }
        .grid-container {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(16, 1fr); 
        }
        .step {
            height: 35px; 
            border: 1px solid #eee;
            cursor: pointer;
        }
        .step:hover { background-color: #f0f0f0; }
        .active-col {
            background-color: #64b5f6 !important; 
            border-color: #1976d2;
        }
        .on { background-color: #4CAF50; } 
        .on.active-col { background-color: #ff9800 !important; } 

        /* New Styles for SVG visualization */
        #envelope-visualizer {
            grid-column: 1 / span 6; /* Span across all 6 columns in the grid */
            margin-top: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            padding: 5px;
        }
        .svg-label {
            font-size: 10px;
            fill: #555;
        }
        .svg-axis {
            stroke: #ddd;
        }
        .svg-curve {
            fill: none;
            stroke: #e74c3c; /* Red color for the curve */
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Simple Web Synth Sequencer (C Major)</h2>
        <p id="status-message" style="color: blue; font-weight: bold; margin-bottom: 10px;">
            Click 'Start Audio' before pressing Play.
        </p>
        
        <button id="audio-init-button" onclick="startAudioContext()">
            1. Click to Start Audio
        </button>

        <div id="synth-controls">
            <div class="control-group">
                <label for="wave-select">VCO Waveform</label>
                <select id="wave-select" onchange="updateSynthParams()">
                    <option value="sawtooth">Sawtooth</option>
                    <option value="square">Square</option>
                    <option value="sine">Sine</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="master-gain">Volume: <span id="gain-val">0.5</span></label>
                <input type="range" id="master-gain" min="0" max="1" step="0.05" value="0.5" oninput="updateMasterGain(this.value)">
            </div>
            
            <div class="control-group">
                <label for="attack-slider">A (s): <span id="attack-val">0.01</span></label>
                <input type="range" id="attack-slider" min="0.005" max="2" step="0.005" value="0.01" oninput="updateSynthParams()">
            </div>
            <div class="control-group">
                <label for="decay-slider">D (s): <span id="decay-val">0.3</span></label>
                <input type="range" id="decay-slider" min="0.05" max="3" step="0.05" value="0.3" oninput="updateSynthParams()">
            </div>
            <div class="control-group">
                <label for="sustain-slider">S (Lvl): <span id="sustain-val">0.5</span></label>
                <input type="range" id="sustain-slider" min="0" max="1" step="0.05" value="0.5" oninput="updateSynthParams()">
            </div>
            <div class="control-group">
                <label for="release-slider">R (s): <span id="release-val">0.5</span></label>
                <input type="range" id="release-slider" min="0.05" max="3" step="0.05" value="0.5" oninput="updateSynthParams()">
            </div>

            <div id="envelope-visualizer">
                <svg id="adsr-svg" width="100%" height="100" viewBox="0 0 400 100" preserveAspectRatio="none">
                    <line x1="0" y1="95" x2="400" y2="95" class="svg-axis" stroke-dasharray="2 2" />
                    <line x1="0" y1="5" x2="400" y2="5" class="svg-axis" stroke-dasharray="2 2" />
                    
                    <text x="5" y="15" class="svg-label">Max</text>
                    <text x="5" y="90" class="svg-label">Zero</text>

                    <polyline id="adsr-curve" points="0,95 100,5 200,50 300,50 400,95" class="svg-curve" />
                </svg>
            </div>
        </div>
        
        <div class="controls">
            <button id="play-button" onclick="togglePlayback()">‚ñ∂Ô∏è Play</button>
            
            <div class="tempo-control">
                <label for="bpm-slider">Tempo (BPM):</label>
                <input type="range" id="bpm-slider" min="60" max="240" value="120" oninput="updateBPM(this.value)">
                <span id="bpm-display">120</span>
            </div>
            
            <button id="clear-button" onclick="clearGrid()">üóëÔ∏è Clear Grid</button>
        </div>

        <div class="grid-wrapper">
            <div class="grid-container" id="sequencer-grid"></div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const C_MAJOR_SCALE = [72, 71, 69, 67, 65, 64, 62, 60]; // C5 to C4
        const NUM_STEPS = 16; 
        const NUM_ROWS = C_MAJOR_SCALE.length;
        
        // --- State Variables (Keep as is) ---
        let isPlaying = false;
        let currentStep = 0;
        let bpm = 120;
        let timerID = null;
        let stepDurationMs = 0; 
        let sequence = Array(NUM_ROWS).fill(0).map(() => Array(NUM_STEPS).fill(false));

        // --- DOM Elements ---
        const statusMessage = document.getElementById('status-message');
        const sequencerGrid = document.getElementById('sequencer-grid');
        const playButton = document.getElementById('play-button');
        const bpmDisplay = document.getElementById('bpm-display');
        const audioInitButton = document.getElementById('audio-init-button');
        
        // --- New SVG DOM Element ---
        const adsrCurve = document.getElementById('adsr-curve'); 

        // --- Web Audio Setup (Keep as is) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let SYNTH_PARAMS = {};
        const masterGainNode = audioCtx.createGain();
        masterGainNode.connect(audioCtx.destination);


        // --- Audio Context Management (Keep as is) ---
        function startAudioContext() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    statusMessage.textContent = "Audio Context Running! Press Play.";
                    audioInitButton.style.display = 'none';
                }).catch(e => {
                    statusMessage.textContent = `Error starting audio: ${e.message}`;
                    statusMessage.style.color = 'red';
                });
            } else {
                 statusMessage.textContent = "Audio Context Running! Press Play.";
                 audioInitButton.style.display = 'none';
            }
        }
        
        // --- Synth Parameter Functions (ADSR, Waveform) ---
        function updateSynthParams() {
            // 1. Update SYNTH_PARAMS from sliders
            SYNTH_PARAMS.attack = parseFloat(document.getElementById('attack-slider').value);
            SYNTH_PARAMS.decay = parseFloat(document.getElementById('decay-slider').value);
            SYNTH_PARAMS.sustain = parseFloat(document.getElementById('sustain-slider').value);
            SYNTH_PARAMS.release = parseFloat(document.getElementById('release-slider').value);
            
            SYNTH_PARAMS.wave = document.getElementById('wave-select').value;
            SYNTH_PARAMS.masterGain = parseFloat(document.getElementById('master-gain').value);

            // 2. Update display values (Keep as is)
            document.getElementById('attack-val').textContent = SYNTH_PARAMS.attack;
            document.getElementById('decay-val').textContent = SYNTH_PARAMS.decay;
            document.getElementById('sustain-val').textContent = SYNTH_PARAMS.sustain;
            document.getElementById('release-val').textContent = SYNTH_PARAMS.release;

            // 3. Update the SVG Visualization (NEW LOGIC)
            drawADSRCurve(SYNTH_PARAMS);
        }

        function drawADSRCurve(params) {
            const SVG_WIDTH = 400;
            const SVG_HEIGHT = 100;
            const Y_MAX = 5; // Y-coordinate for 1.0 amplitude (top of SVG)
            const Y_MIN = 95; // Y-coordinate for 0.0 amplitude (bottom of SVG)

            // Determine max X for Attack and Decay segments (a fixed visual length for A+D+S)
            // Total visual duration is normalized, e.g., 300 units for A+D+S
            const totalDuration = params.attack + params.decay + 1.0; // Normalize A and D against a fixed sustain time
            
            // Normalize A and D times to a segment of the SVG width (e.g., 200 units for A+D)
            const maxTimeVisual = 300; // Total X for A, D, and S phases

            const attackRatio = params.attack / totalDuration;
            const decayRatio = params.decay / totalDuration;

            // --- X Coordinates ---
            const X0 = 0;                                 // Start: (0, 0)
            const X1 = X0 + (maxTimeVisual * attackRatio);          // End of Attack
            const X2 = X1 + (maxTimeVisual * decayRatio);          // End of Decay / Start of Sustain
            const X3 = X2 + (maxTimeVisual * (1 - attackRatio - decayRatio)); // End of Sustain gate
            const X4 = SVG_WIDTH;                         // End of Release (end of SVG)

            // --- Y Coordinates (Volume Level) ---
            // Map 0.0 to 1.0 amplitude to Y_MIN to Y_MAX coordinates
            const Y_map = (level) => Y_MIN - (level * (Y_MIN - Y_MAX));

            const Y_START = Y_map(0);    // 0.0 (Bottom)
            const Y_PEAK = Y_map(1);     // 1.0 (Top)
            const Y_SUSTAIN = Y_map(params.sustain); // Sustain Level

            // The points string for the SVG polyline element:
            const points = [
                `${X0},${Y_START}`,           // 0. Start (A=0, V=0)
                `${X1},${Y_PEAK}`,            // 1. Attack Peak (A=Time, V=1)
                `${X2},${Y_SUSTAIN}`,         // 2. Decay End (D=Time, V=Sustain Level)
                `${X3},${Y_SUSTAIN}`,         // 3. Sustain (Hold level)
                `${X4},${Y_START}`            // 4. Release End (R=Time, V=0)
            ].join(' ');

            adsrCurve.setAttribute('points', points);
        }
        
        // --- Other Synth, Sequencer, and Grid Functions (Keep as is) ---
        
        function updateMasterGain(value) {
            SYNTH_PARAMS.masterGain = parseFloat(value);
            document.getElementById('gain-val').textContent = SYNTH_PARAMS.masterGain;
            masterGainNode.gain.setValueAtTime(SYNTH_PARAMS.masterGain, audioCtx.currentTime);
        }

        function midiToFreq(midiNote) {
            return 440 * Math.pow(2, (midiNote - 69) / 12);
        }

        function playSynthNote(midiNote) {
            const now = audioCtx.currentTime;
            const frequency = midiToFreq(midiNote);
            const maxAmplitude = 1; 

            const oscillator = audioCtx.createOscillator();
            oscillator.type = SYNTH_PARAMS.wave;
            oscillator.frequency.setValueAtTime(frequency, now);

            const envelopeGain = audioCtx.createGain();
            envelopeGain.gain.setValueAtTime(0.0001, now); 

            oscillator.connect(envelopeGain).connect(masterGainNode);

            envelopeGain.gain.linearRampToValueAtTime(maxAmplitude, now + SYNTH_PARAMS.attack);
            envelopeGain.gain.setTargetAtTime(SYNTH_PARAMS.sustain * maxAmplitude + 0.0001, now + SYNTH_PARAMS.attack, SYNTH_PARAMS.decay / 5);
            
            oscillator.start(now);
            
            scheduleNoteRelease(midiNote, oscillator, envelopeGain, now + (stepDurationMs / 1000) * 0.95); 
        }
        
        function scheduleNoteRelease(midiNote, oscillator, envelopeGain, releaseTime) {
            const now = audioCtx.currentTime;
            
            envelopeGain.gain.cancelScheduledValues(releaseTime);
            envelopeGain.gain.setValueAtTime(envelopeGain.gain.value, releaseTime);
            envelopeGain.gain.exponentialRampToValueAtTime(0.0001, releaseTime + SYNTH_PARAMS.release);

            oscillator.stop(releaseTime + SYNTH_PARAMS.release);
        }
        
        function calculateStepDuration() {
            stepDurationMs = (60 / bpm) / 4 * 1000; 

            if (isPlaying) {
                clearInterval(timerID);
                timerID = setInterval(stepSequencer, stepDurationMs);
            }
        }
        
        function updateBPM(newBPM) {
            bpm = parseInt(newBPM);
            bpmDisplay.textContent = bpm;
            calculateStepDuration();
        }

        function togglePlayback() {
            if (audioCtx.state !== 'running') {
                statusMessage.textContent = "Please click 'Start Audio' first!";
                return;
            }

            isPlaying = !isPlaying;

            if (isPlaying) {
                playButton.textContent = "‚è∏Ô∏è Stop";
                playButton.classList.add('playing');
                currentStep = 0; 
                timerID = setInterval(stepSequencer, stepDurationMs);
            } else {
                playButton.textContent = "‚ñ∂Ô∏è Play";
                playButton.classList.remove('playing');
                clearInterval(timerID);
                timerID = null;
                
                document.querySelectorAll('.step').forEach(el => el.classList.remove('active-col'));
            }
        }

        function stepSequencer() {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active-col'));
            
            for (let row = 0; row < NUM_ROWS; row++) {
                const elementIndex = row * NUM_STEPS + currentStep;
                const stepElement = sequencerGrid.children[elementIndex];
                if (stepElement) {
                    stepElement.classList.add('active-col');
                }
            }

            for (let row = 0; row < NUM_ROWS; row++) {
                if (sequence[row][currentStep]) {
                    const noteNumber = C_MAJOR_SCALE[row];
                    playSynthNote(noteNumber);
                }
            }

            currentStep = (currentStep + 1) % NUM_STEPS;
        }

        function createGrid() {
            sequencerGrid.innerHTML = '';

            for (let row = 0; row < NUM_ROWS; row++) {
                for (let col = 0; col < NUM_STEPS; col++) {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'step';
                    stepElement.dataset.row = row;
                    stepElement.dataset.col = col;
                    
                    if (col % 4 === 0) { 
                        stepElement.style.borderLeft = '1px solid #777';
                    }

                    stepElement.onclick = () => toggleStep(row, col, stepElement);
                    sequencerGrid.appendChild(stepElement);
                }
            }
            calculateStepDuration();
        }

        function toggleStep(row, col, element) {
            sequence[row][col] = !sequence[row][col];
            element.classList.toggle('on', sequence[row][col]);
        }
        
        function clearGrid() {
            sequence = Array(NUM_ROWS).fill(0).map(() => Array(NUM_STEPS).fill(false));
            document.querySelectorAll('.step').forEach(el => el.classList.remove('on'));
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateSynthParams(); // This now calls drawADSRCurve()
            createGrid();
        });
    </script>
</body>
</html>