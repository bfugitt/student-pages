<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Fact Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom styles for the input box and flash effects */
        #answerInput {
            transition: all 0.1s ease-in-out;
        }
        .correct-flash {
            border-color: #10B981 !important; /* Green 500 */
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.7) !important;
        }
        .incorrect-flash {
            border-color: #EF4444 !important; /* Red 500 */
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.7) !important;
        }
        /* Style for the checkbox/toggle */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.5em;
            height: 1.5em;
            border: 2px solid #ccc;
            border-radius: 0.35em;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            cursor: pointer;
        }
        input[type="checkbox"]:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        input[type="checkbox"]:checked::before {
            content: "‚úì";
            color: white;
            font-size: 1.1em;
            font-weight: 900;
        }

        /* Custom slider track/thumb styling for aesthetics */
        input[type=range]::-webkit-slider-runnable-track {
            background: #9ca3af;
            height: 8px;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5;
            margin-top: -6px;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
            cursor: grab;
        }
        /* Custom styles for the purple slider track */
        #maxMultSlider::-webkit-slider-runnable-track {
            background: #a78bfa; /* purple-400 */
        }
        #maxMultSlider::-webkit-slider-thumb {
            background: #7c3aed; /* purple-600 */
        }

        /* --- PRINT STYLES FIX --- */
        @media print {
            
            /* 1. Hide the main title */
            #appContainer > h1 {
                display: none;
            }

            /* 2. Hide the print/new practice buttons */
            .print-controls {
                display: none !important;
            }
            
            /* 3. Remove shadows, background, and padding from app container for clean printing */
            #appContainer {
                padding: 0 !important;
                box-shadow: none !important;
                max-width: 100% !important; /* Allow it to take full width of page */
                background-color: transparent !important;
                /* Ensure it centers content on the page */
                margin: 0 auto !important; 
            }

            /* 4. Ensure the body background is white and takes full screen */
            body {
                background-color: white !important;
                min-height: 100vh;
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* 5. Certificate box styling for clean print border/margins */
            .certificate-box {
                border: 10px solid #4f46e5 !important;
                box-shadow: none !important;
                padding: 40px !important;
                margin: 20px auto !important; /* Center the box with some page margin */
                max-width: 1000px; /* Wider limit for better landscape look */
                box-sizing: border-box;
            }

            /* 6. Ensure the certificate wrapper doesn't introduce unwanted space */
            #certificateContainer {
                padding: 0 !important;
                margin: 0 !important;
            }

            /* 7. Adjust font sizes for print legibility */
            .text-6xl { font-size: 3em !important; }
            .text-5xl { font-size: 2.5em !important; }
            .text-3xl { font-size: 1.5em !important; }
            .text-2xl { font-size: 1.25em !important; }
        }
        /* --- END PRINT STYLES FIX --- */
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="appContainer" class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-lg transition-all duration-300">
        <h1 class="text-4xl font-extrabold text-indigo-700 text-center mb-8">
            <span class="inline-block transform -rotate-6 text-yellow-500 mr-2">‚≠ê</span>
            Math Fact Master
            <span class="inline-block transform rotate-6 text-green-500 ml-2">üß†</span>
        </h1>

        <div id="screenContainer">
            </div>
    </div>

    <script>
        // --- CONFIGURATION & STATE ---
        const config = {
            1: { target: 10, maxFact: 20, maxMult: 0, ops: ['+', '-'] },
            2: { target: 20, maxFact: 20, maxMult: 0, ops: ['+', '-'] },
            3: { target: 30, maxFact: 20, maxMult: 12, ops: ['+', '-', '*'] },
            4: { target: 40, maxFact: 20, maxMult: 12, ops: ['+', '-', '*', '/'] },
            5: { target: 50, maxFact: 20, maxMult: 12, ops: ['+', '-', '*', '/'] },
        };
        
        // NEW: Cooldown time for incorrect answers
        const COOLDOWN_TIME = 2500; // 3000 = 3 seconds

        let currentOpList = [];

        let currentProblem = {};
        let currentGrade = 0;
        let score = 0;
        let attempted = 0;
        let timer = 0;
        let gameInterval = null;
        const GAME_DURATION = 60; // seconds
        let state = 'SELECT_GRADE'; // SELECT_GRADE | GAME | RESULTS | CERTIFICATE | LEADERBOARD
        let isMultipleChoice = false;
        
        // NEW: State to track if player is in penalty cooldown
        let isCoolingDown = false; 

        let maxFactValue = 20; 
        let maxMultValue = 12;

        const screenContainer = document.getElementById('screenContainer');

        // --- LEADERBOARD CONFIG ---
        const LEADERBOARD_URL = 'https://script.google.com/macros/s/AKfycbxK4qygaYpKZxZdQTP8DhGhmNWXD5WN2dSTal5jbRnIu4XmGEOJIPM85MDvr02zU5C6xw/exec'; 
        // --- END LEADERBOARD CONFIG --- 

        // Initialize simple synth for sound effects
        const correctSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" } }).toDestination();
        const incorrectSynth = new Tone.NoiseSynth({
            noise: { type: "pink" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
        }).toDestination();
        const successSynth = new Tone.PolySynth(Tone.AMSynth).toDestination();
        const achievementSynth = new Tone.MembraneSynth().toDestination();

        function playCorrectSound() { correctSynth.triggerAttackRelease(["C5", "E5"], "8n"); }
        function playIncorrectSound() { incorrectSynth.triggerAttackRelease("16n"); }
        function playSuccessSound() { successSynth.triggerAttackRelease(["C4", "E4", "G4"], "0.5"); }
        function playAchievementSound() { achievementSynth.triggerAttackRelease("C3", "0.5"); achievementSynth.triggerAttackRelease("G3", "0.5", Tone.now() + 0.3); }

        // --- LEADERBOARD FUNCTIONS ---
        
        /**
         * Sends achievement data to the Google Apps Script via POST request.
         */
        function submitLeaderboardData(name, score, time, gradeLevel) {
            const data = {
                Name: name,
                Score: score,
                Time: time,
                GradeLevel: gradeLevel
            };

            fetch(LEADERBOARD_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data).toString()
            })
            .then(() => {
                console.log("Leaderboard data submission initiated. Check Sheet for verification.");
            })
            .catch(error => {
                console.error('Error submitting leaderboard data:', error);
            });
        }
        
        /**
         * Fetches all leaderboard data from the Google Apps Script via GET request.
         */
        function fetchLeaderboardData() {
            renderLoadingScreen();

            // We use the same URL but the GET request will trigger the doGet function
            fetch(LEADERBOARD_URL, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                // If the script returns valid JSON, we process it.
                if (data && data.leaderboard) {
                    renderLeaderboard(data.leaderboard);
                } else {
                    renderLeaderboard([]); // Render empty if data format is unexpected
                }
            })
            .catch(error => {
                console.error('Error fetching leaderboard data:', error);
                renderErrorScreen('Could not connect to the leaderboard. Please try again later.');
            });
        }
        
        /**
         * Renders a simple loading screen while data is being fetched.
         */
        function renderLoadingScreen() {
            screenContainer.innerHTML = `
                <div class="text-center p-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-500 mx-auto mb-4"></div>
                    <h2 class="text-2xl font-semibold text-gray-700">Loading Leaderboard...</h2>
                    <p class="text-gray-500 mt-2">Fetching mastery achievements from the server.</p>
                </div>
            `;
            state = 'LOADING';
        }

        /**
         * Renders the fetched leaderboard data in an appealing table.
         */
        function renderLeaderboard(data) {
            
            // Function to determine medal/emoji based on rank
            function getRankDisplay(rank) {
                if (rank === 1) return '<span class="text-4xl">ü•á</span>';
                if (rank === 2) return '<span class="text-3xl">ü•à</span>';
                if (rank === 3) return '<span class="text-2xl">ü•â</span>';
                return `<span class="text-lg font-bold text-gray-500">${rank}</span>`;
            }

            // Function to format the date
            function formatDate(dateValue) {
                const date = new Date(dateValue);
                // Return 'Invalid Date' if parsing failed
                if (isNaN(date)) return 'N/A';
                
                // Format as MMM D, YYYY
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }


            let leaderboardContent;
            if (data.length === 0) {
                leaderboardContent = `
                    <div class="text-center p-10 bg-yellow-50 rounded-xl">
                        <p class="text-xl font-semibold text-yellow-700">No Certificates Awarded Yet! üèÜ</p>
                        <p class="text-gray-600 mt-2">Be the first to master a level at max difficulty and claim a spot!</p>
                    </div>
                `;
            } else {
                let rows = data.map((entry, index) => {
                    const rank = index + 1;
                    const rowClass = rank <= 3 ? 'bg-yellow-100 font-bold border-yellow-300' : 'bg-white border-gray-200';
                    const nameCellClass = rank <= 3 ? 'text-indigo-700' : 'text-gray-800';
                    const scoreCellClass = rank <= 3 ? 'text-green-700' : 'text-green-600';
                    
                    return `
                        <tr class="border-b ${rowClass} hover:bg-indigo-50 transition duration-150">
                            <td class="px-4 py-3 text-center">${getRankDisplay(rank)}</td>
                            <td class="px-4 py-3 text-left ${nameCellClass}">${entry.Name}</td>
                            <td class="px-4 py-3 text-center ${scoreCellClass}">${entry.Score}</td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600">${entry.GradeLevel}</td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600">${formatDate(entry.Date)}</td>
                        </tr>
                    `;
                }).join('');

                leaderboardContent = `
                    <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-700 text-white sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider rounded-tl-lg">Rank</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold uppercase tracking-wider">Name</th>
                                    <th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider">Score</th>
                                    <th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider">Level</th>
                                    <th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider rounded-tr-lg">Date</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            screenContainer.innerHTML = `
                <h2 class="text-3xl font-extrabold text-indigo-700 text-center mb-6">Mastery Leaderboard üëë</h2>
                <p class="text-center text-gray-600 mb-8">Top scores earned on a 60-second timer at the highest difficulty settings.</p>

                ${leaderboardContent}
                
                <button onclick="renderSelectGrade()"
                        class="mt-8 w-full py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-red-300">
                    ‚Üê Back to Practice
                </button>
            `;
            state = 'LEADERBOARD';
        }
        
        /**
         * Renders a basic error screen.
         */
        function renderErrorScreen(message) {
            screenContainer.innerHTML = `
                <div class="text-center p-12 bg-red-100 border-2 border-red-400 rounded-xl">
                    <h2 class="text-2xl font-semibold text-red-700 mb-4">Error! üö´</h2>
                    <p class="text-red-600">${message}</p>
                    <button onclick="renderSelectGrade()"
                            class="mt-6 w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl shadow-lg transition duration-150">
                        Return to Start
                    </button>
                </div>
            `;
            state = 'ERROR';
        }
        // --- END LEADERBOARD FUNCTIONS ---


        // --- PROBLEM GENERATION LOGIC ---

        function randInt(min, max) {
            return Math.floor(Math.random() * (max - min)) + min;
        }

        function generateProblem(grade, opList) {
            const op = opList[randInt(0, opList.length)];
            let num1, num2, answer, problemText;
            
            if (op === '+' || op === '-') {
                const maxLimit = maxFactValue;
                
                if (op === '+') {
                    let sum;
                    do {
                        num1 = randInt(1, maxLimit); 
                        num2 = randInt(1, maxLimit);
                        sum = num1 + num2;
                    } while (sum > maxLimit); 

                    answer = sum;
                    problemText = `${num1} + ${num2} =`;
                } else {
                    num1 = randInt(1, maxLimit + 1); 
                    num2 = randInt(0, num1); 
                    
                    answer = num1 - num2;
                    problemText = `${num1} - ${num2} =`;
                }
            }
            else if (op === '*' || op === '/') {
                const maxFactor = maxMultValue;
                
                if (op === '*') {
                    num1 = randInt(0, maxFactor + 1);
                    num2 = randInt(0, maxFactor + 1);
                    answer = num1 * num2;
                    problemText = `${num1} √ó ${num2} =`;
                } else {
                    const factor1 = randInt(1, maxFactor + 1);
                    const factor2 = randInt(1, maxFactor + 1);
                    const product = factor1 * factor2;

                    if (Math.random() < 0.5) {
                        num1 = product;
                        num2 = factor1;
                        answer = factor2;
                    } else {
                        num1 = product;
                        num2 = factor2;
                        answer = factor1;
                    }
                    problemText = `${num1} √∑ ${num2} =`;
                }
            }

            return { problemText, answer };
        }

        function generateChoices(correctAnswer) {
            const choices = new Set();
            choices.add(correctAnswer);

            while (choices.size < 4) {
                let distractor;
                const deviation = randInt(-4, 5); 
                distractor = correctAnswer + deviation;

                if (distractor >= 0 && !choices.has(distractor)) {
                    choices.add(distractor);
                }
                if (choices.size < 4 && correctAnswer < 5) {
                     distractor = randInt(0, 10);
                     if (distractor >= 0 && !choices.has(distractor)) choices.add(distractor);
                }
            }

            const choicesArray = Array.from(choices);
            for (let i = choicesArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [choicesArray[i], choicesArray[j]] = [choicesArray[j], choicesArray[i]];
            }

            return choicesArray;
        }

        // --- UI RENDERING FUNCTIONS ---


        window.toggleMultipleChoice = function(checked) {
            isMultipleChoice = checked;
        }

        window.updateMaxFactValue = function(value) {
            maxFactValue = parseInt(value, 10);
            document.getElementById('maxFactValueDisplay').textContent = maxFactValue;
        }

        window.updateMaxMultValue = function(value) {
            maxMultValue = parseInt(value, 10);
            document.getElementById('maxMultValueDisplay').textContent = maxMultValue;
        }


        /**
         * Renders the grade selection screen.
         */
        function renderSelectGrade() {
            let gradeButtons = '';
            for (let g = 1; g <= 5; g++) {
                const gradeDetails = config[g];
                const opsAvailable = g <= 2 ? 'Addition, Subtraction' : g === 3 ? 'A/S, Multiplication' : 'All Four Operations';
                gradeButtons += `
                    <button onclick="startGame(${g})"
                            class="w-full text-left p-4 mb-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        <span class="font-bold text-lg">${g}${g === 1 ? 'st' : g === 2 ? 'nd' : g === 3 ? 'rd' : 'th'} Grade</span>
                        <div class="text-sm opacity-90">
                            Target: ${gradeDetails.target} in 1 min. | Ops: ${opsAvailable}
                        </div>
                    </button>
                `;
            }

            screenContainer.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Set Practice Options</h2>

                <div class="p-4 rounded-xl bg-indigo-50 border border-indigo-200 mb-6">
                    <label class="text-lg font-extrabold text-gray-800 mb-3 block">
                        Max Addition / Subtraction Fact Value: 
                        <span id="maxFactValueDisplay" class="text-indigo-600">${maxFactValue}</span>
                        <span class="text-xs text-gray-500 font-normal">(Max value for sums/minuends)</span>
                    </label>
                    <input type="range" id="maxFactSlider" min="5" max="20" step="1" 
                           value="${maxFactValue}" 
                           oninput="updateMaxFactValue(this.value)"
                           class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-sm text-gray-600 mt-1">
                        <span>5</span>
                        <span>20 (Max)</span>
                    </div>
                </div>

                <div class="p-4 rounded-xl bg-purple-50 border border-purple-200 mb-6">
                    <label class="text-lg font-extrabold text-gray-800 mb-3 block">
                        Max Multiplication / Division Factor: 
                        <span id="maxMultValueDisplay" class="text-purple-600">${maxMultValue}</span>
                        <span class="text-xs text-gray-500 font-normal">(Max value for factors)</span>
                    </label>
                    <input type="range" id="maxMultSlider" min="1" max="12" step="1" 
                           value="${maxMultValue}" 
                           oninput="updateMaxMultValue(this.value)"
                           class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-sm text-gray-600 mt-1">
                        <span>1 (Easy)</span>
                        <span>12 (Max)</span>
                    </div>
                </div>


                <div class="p-4 rounded-xl bg-yellow-50 border border-yellow-200 mb-6">
                    <p class="text-sm text-gray-700 font-bold">
                        Operations are automatically set by your Grade Level choice below.
                    </p>
                </div>

 
                <div class="flex items-center justify-between p-4 mb-8 rounded-xl bg-gray-100 shadow-inner">
                    <label for="mc-toggle" class="text-lg font-semibold text-gray-700">Use Multiple Choice (Easier Input)?</label>
                    <input type="checkbox" id="mc-toggle" ${isMultipleChoice ? 'checked' : ''} onchange="toggleMultipleChoice(this.checked)">
                </div>

                <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Choose Grade Level</h2>

                <div class="space-y-3 mb-8">
                    ${gradeButtons}
                </div>
                
                <button onclick="fetchLeaderboardData()"
                        class="w-full py-3 bg-red-400 hover:bg-red-500 text-white font-bold rounded-xl transition duration-150 shadow-md">
                    View Mastery Leaderboard üèÜ
                </button>
            `;
            state = 'SELECT_GRADE';
        }

        /**
         * Renders the main game screen (conditional input/buttons).
         */
        function renderGame() {
            const target = config[currentGrade].target;
            const gradeText = `${currentGrade}${currentGrade === 1 ? 'st' : currentGrade === 2 ? 'nd' : currentGrade === 3 ? 'rd' : 'th'}`;

            let inputElement;
            let helperText;

            if (isMultipleChoice) {
                inputElement = `<div id="choicesContainer" class="grid grid-cols-2 gap-4"></div>`;
                helperText = '<p class="text-base text-gray-500">Click the correct answer!</p>';
            } else {
                inputElement = `
                    <input type="number" id="answerInput"
                           class="w-full p-4 text-center text-4xl font-extrabold text-gray-800 border-4 border-indigo-300 rounded-xl focus:ring-4 focus:ring-indigo-400 focus:border-indigo-500 transition-all duration-200"
                           placeholder="?" autofocus>
                `;
                helperText = '<p class="text-base text-gray-500">Correct answers submit automatically. Press ENTER to check an incorrect answer.</p>';
            }

            screenContainer.innerHTML = `
                <div class="flex justify-between items-center mb-6 text-lg font-medium text-gray-600">
                    <div>Grade: <span class="font-bold text-indigo-700">${gradeText}</span></div>
                    <div>Target: <span class="font-bold text-indigo-700">${target}</span></div>
                </div>

                <div class="flex justify-between items-center mb-8 p-4 bg-gray-100 rounded-lg shadow-inner">
                    <div id="scoreDisplay" class="text-2xl font-bold text-green-600">Score: 0</div>
                    <div id="timerDisplay" class="text-3xl font-extrabold text-red-500">60s</div>
                </div>

                <div class="flex flex-col items-center justify-center h-40 bg-indigo-50 rounded-xl shadow-md p-6 mb-8">
                    <p id="problemText" class="text-5xl font-extrabold text-indigo-800 mb-4 select-none">
                        </p>
                    ${helperText}
                </div>

                ${inputElement}

                <button onclick="endGameEarly()" class="mt-4 w-full py-2 bg-red-400 hover:bg-red-500 text-white font-bold rounded-xl transition duration-150 shadow-md">
                    End Practice
                </button>
            `;
            state = 'GAME';
            setupGameListeners();
            nextProblem();
        }

        /**
         * Renders the results screen with 'Try Again' option, and checks for achievement.
         */
        function renderResults() {
            const target = config[currentGrade].target;
            const gradeText = `${currentGrade}${currentGrade === 1 ? 'st' : currentGrade === 2 ? 'nd' : currentGrade === 3 ? 'rd' : 'th'}`;

            const accuracyRaw = attempted > 0 ? (score / attempted) : 0;
            const accuracy = (accuracyRaw * 100).toFixed(0);

            const passed = score >= target;

            const gradeMaxFact = config[currentGrade].maxFact;
            const gradeMaxMult = config[currentGrade].maxMult;
            const ACCURACY_THRESHOLD = 0.9; 

            const isMaxAS = maxFactValue === gradeMaxFact;
            const isMaxMD = currentGrade < 3 || maxMultValue === gradeMaxMult; 

            const isMaxLevel = isMaxAS && isMaxMD;
            
            const achievedMastery = passed && isMaxLevel && (accuracyRaw >= ACCURACY_THRESHOLD);
            
            if (achievedMastery) {
                playAchievementSound();
                promptForNameAndRenderCertificate(gradeText, score, attempted, accuracy);
                return;
            } else if (passed) {
                playSuccessSound();
            }

            screenContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-center mb-6 ${passed ? 'text-green-600' : 'text-red-600'}">
                    ${passed ? 'FANTASTIC WORK! GOAL REACHED!' : 'Keep Practicing!'}
                </h2>

                <div class="p-6 bg-gray-100 rounded-xl shadow-inner mb-8">
                    <p class="text-lg font-medium text-gray-700 mb-2">Grade: <span class="font-bold text-indigo-700">${gradeText}</span></p>
                    <p class="text-lg font-medium text-gray-700 mb-2">Target Score: <span class="font-bold text-indigo-700">${target}</span></p>
                    <hr class="my-4 border-gray-300">
                    <p class="text-xl font-bold text-green-600 mb-2">Correct Answers: ${score}</p>
                    <p class="text-xl font-bold text-gray-800 mb-2">Total Attempted: ${attempted}</p>
                    <p class="text-xl font-bold text-indigo-700">Accuracy: ${accuracy}%</p>
                </div>

                <div class="text-center mb-6">
                    <p class="text-2xl font-extrabold ${passed ? 'text-green-700' : 'text-red-700'}">
                        ${passed ? 'Target Met!' : `Needed ${target - score} more correct answers.`}
                    </p>
                    ${isMaxLevel && !passed ? 
                        `<p class="text-lg text-red-500 mt-2">You were practicing at max difficulty! Keep going!</p>` : 
                        isMaxLevel === false && passed ? 
                        `<p class="text-lg text-green-700 mt-2">Try again at the max slider settings to earn a certificate!</p>` : ''
                    }
                    ${(passed && isMaxLevel && accuracyRaw < ACCURACY_THRESHOLD) ?
                        `<p class="text-lg text-red-500 mt-2">You need 90% accuracy or higher to earn the Mastery Certificate.</p>` : ''
                    }
                </div>

                <div class="flex space-x-4">
                    <button onclick="startGame(${currentGrade})"
                            class="w-1/2 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-green-300">
                        Keep Practicing (Grade ${currentGrade})
                    </button>

                    <button onclick="renderSelectGrade()"
                            class="w-1/2 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        Try Another Grade
                    </button>
                </div>
            `;
            state = 'RESULTS';
        }

        /**
         * Renders the Certificate of Mastery.
         */
        window.renderCertificate = function(studentName, gradeText, score, attempted, accuracy) {
            
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            screenContainer.innerHTML = `
                <div id="certificateContainer" class="p-4 md:p-8">
                    <div class="certificate-box border-8 border-indigo-500 p-8 md:p-12 rounded-3xl shadow-2xl bg-white text-center">
                        
                        <h3 class="text-3xl font-extrabold text-yellow-600 mb-4">CERTIFICATE OF MASTERY</h3>
                        
                        <h2 class="text-5xl font-black text-indigo-700 mb-6">Math Fact Master</h2>
                        
                        <p class="text-2xl text-gray-700 mt-8 mb-4">This certificate is proudly presented to</p>
                        
                        <p class="text-6xl font-black text-green-600 border-b-4 border-green-300 inline-block px-8 py-2 mb-10 transform rotate-1">
                            ${studentName.toUpperCase() || 'A Math Master'}
                        </p>

                        <p class="text-2xl font-semibold text-gray-800 mb-10">
                            For achieving ${gradeText} Grade Fact Mastery
                            <br>
                            at the Maximum Difficulty setting!
                        </p>

                        <div class="grid grid-cols-3 gap-4 text-center mb-10">
                            <div class="p-3 bg-indigo-50 rounded-lg">
                                <p class="text-xl font-bold text-indigo-700">${score}</p>
                                <p class="text-sm text-gray-600">Correct Answers</p>
                            </div>
                            <div class="p-3 bg-indigo-50 rounded-lg">
                                <p class="text-xl font-bold text-indigo-700">${attempted}</p>
                                <p class="text-sm text-gray-600">Total Attempted</p>
                            </div>
                            <div class="p-3 bg-indigo-50 rounded-lg">
                                <p class="text-xl font-bold text-indigo-700">${accuracy}%</p>
                                <p class="text-sm text-gray-600">Accuracy</p>
                            </div>
                        </div>

                        <p class="text-lg text-gray-700 mt-6">Completed on: <span class="font-bold text-indigo-700">${date}</span></p>

                    </div>
                </div>

                <div class="print-controls mt-8 pt-4 border-t border-gray-200">
                    <button onclick="window.print()"
                            class="w-full py-3 mb-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-green-300">
                        Print / Save Certificate (Use Browser's Print Function)
                    </button>
                    <button onclick="renderSelectGrade()"
                            class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        Start New Practice
                    </button>
                </div>
            `;
            state = 'CERTIFICATE';
        }

        /**
         * Prompts for the student's name before rendering the certificate.
         */
        function promptForNameAndRenderCertificate(gradeText, score, attempted, accuracy) {
             
            screenContainer.innerHTML = `
                <div class="p-6 bg-yellow-100 border-4 border-yellow-400 rounded-xl text-center shadow-2xl">
                    <h2 class="text-3xl font-extrabold text-yellow-700 mb-4">Mastery Unlocked! üèÖ</h2>
                    <p class="text-xl text-gray-800 mb-6">You passed the ${gradeText} Grade challenge at max difficulty with high accuracy!</p>
                    
                    <label for="studentNameInput" class="block text-lg font-semibold text-gray-700 mb-2">
                        Enter your name for the certificate and leaderboard:
                    </label>
                    <input type="text" id="studentNameInput" 
                           class="w-full p-3 text-center text-2xl font-bold text-gray-800 border-2 border-indigo-400 rounded-lg focus:ring-2 focus:ring-indigo-500 mb-6"
                           placeholder="Your Name">
                           
                    <button onclick="submitCertificateName('${gradeText}', ${score}, ${attempted}, '${accuracy}')"
                            class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl shadow-lg transition duration-150">
                        Create My Certificate
                    </button>
                </div>
            `;
            document.getElementById('studentNameInput').focus();
        }

        /**
         * Handles the name submission and calls the final certificate renderer.
         */
        window.submitCertificateName = function(gradeText, score, attempted, accuracy) {
            const studentName = document.getElementById('studentNameInput').value;
            const finalName = studentName.trim() === '' ? 'A Math Master' : studentName;
            
            // Submits data to Google Sheet
            submitLeaderboardData(
                finalName, 
                score, 
                GAME_DURATION, 
                gradeText      
            );

            renderCertificate(finalName, gradeText, score, attempted, accuracy);
        }
        
        // --- GAME FLOW LOGIC ---

        window.endGameEarly = function() {
            if (gameInterval) clearInterval(gameInterval);
            currentGrade = 0;
            state = 'SELECT_GRADE';
            renderSelectGrade();
        }

        function startGame(grade) {
            if (gameInterval) clearInterval(gameInterval);

            currentGrade = grade;
            score = 0;
            attempted = 0;
            timer = GAME_DURATION;
            isCoolingDown = false; // NEW: Reset cooldown state

            currentOpList = config[grade].ops;
            
            if (currentOpList.length === 0) {
                 currentOpList = ['+']; 
            }

            renderGame();
            updateTimerDisplay();
            updateScoreDisplay();

            gameInterval = setInterval(() => {
                timer--;
                updateTimerDisplay();
                if (timer <= 0) {
                    clearInterval(gameInterval);
                    renderResults();
                }
            }, 1000);
        }

        /**
         * Displays the next math problem.
         * UPDATED: Now also resets the helper text after a penalty.
         */
        function nextProblem() {
            currentProblem = generateProblem(currentGrade, currentOpList);
            const problemTextEl = document.getElementById('problemText');
            problemTextEl.textContent = currentProblem.problemText;

            // NEW: Reset helper text in case it was changed by penalty
            const problemContainer = problemTextEl.parentElement;
            const helperTextEl = problemContainer.querySelector('p.text-base');
            if (helperTextEl) {
                if (isMultipleChoice) {
                    helperTextEl.textContent = 'Click the correct answer!';
                } else {
                    helperTextEl.textContent = 'Correct answers submit automatically. Press ENTER to check an incorrect answer.';
                }
            }
            // END NEW

            if (isMultipleChoice) {
                const choices = generateChoices(currentProblem.answer);
                const choicesContainer = document.getElementById('choicesContainer');
                
                let buttonsHTML = '';
                choices.forEach(choice => {
                    buttonsHTML += `
                        <button onclick="checkAnswer(${choice})"
                                class="py-4 text-3xl font-bold bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-105">
                            ${choice}
                        </button>
                    `;
                });
                choicesContainer.innerHTML = buttonsHTML;
            } else {
                const input = document.getElementById('answerInput');
                if (input) { // Check if input exists
                    input.value = '';
                    input.focus();
                }
            }
        }

        /**
         * Sets up event listeners for the game input (used only in typing mode).
         * UPDATED: Added isCoolingDown checks to prevent input during penalty.
         */
        function setupGameListeners() {
            if (isMultipleChoice) return;

            const input = document.getElementById('answerInput');
            if (input) {
                input.addEventListener('input', (e) => {
                    // NEW: Add guard
                    if (isCoolingDown) return; 
                    
                    const userAnswer = e.target.value;
                    const correctAnswer = currentProblem.answer.toString();

                    if (userAnswer.length === correctAnswer.length && parseInt(userAnswer, 10) === currentProblem.answer) {
                        checkAnswer(userAnswer);
                    }
                });

                input.addEventListener('keydown', (e) => {
                    // NEW: Add guard
                    if (isCoolingDown) return; 
                    
                    if (e.key === 'Enter') {
                        checkAnswer(input.value);
                    }
                });
            }
        }

        /**
         * Checks the user's answer against the correct answer.
         * UPDATED: Now includes penalty logic for incorrect answers.
         */
        function checkAnswer(inputValue) {
            // NEW: Added isCoolingDown check
            if (state !== 'GAME' || timer <= 0 || isCoolingDown) return;

            const userAnswer = parseInt(inputValue, 10);
            const isCorrect = userAnswer === currentProblem.answer;

            attempted++;

            if (isCorrect) {
                playCorrectSound();
                score++;
                updateScoreDisplay();

                const input = document.getElementById('answerInput');
                if (input && !isMultipleChoice) {
                    input.classList.add('correct-flash');
                    setTimeout(() => input.classList.remove('correct-flash'), 200);
                }

                setTimeout(nextProblem, isMultipleChoice ? 100 : 0);
            } else {
                // --- NEW PENALTY LOGIC START ---
                playIncorrectSound();
                isCoolingDown = true;

                // Get UI elements
                const problemTextEl = document.getElementById('problemText');
                const problemContainer = problemTextEl.parentElement;
                const helperTextEl = problemContainer.querySelector('p.text-base');

                // Show the correct answer
                problemTextEl.innerHTML = `<span class="text-5xl font-extrabold text-green-600">${currentProblem.problemText} ${currentProblem.answer}</span>`;
                
                // Show a penalty message
                if(helperTextEl) {
                    helperTextEl.innerHTML = `<span class="text-red-500 font-bold">‚ùå NOPE! Wait ${COOLDOWN_TIME / 1000} seconds...</span>`;
                }

                // Disable all inputs
                if (isMultipleChoice) {
                    const choicesContainer = document.getElementById('choicesContainer');
                    const choiceButtons = choicesContainer.querySelectorAll('button');
                    choiceButtons.forEach(btn => btn.disabled = true);
                } else {
                    const input = document.getElementById('answerInput');
                    if (input) {
                        input.disabled = true;
                        input.classList.add('incorrect-flash'); // Add persistent flash
                    }
                }

                // Set the cooldown timer
                setTimeout(() => {
                    // End of cooldown
                    isCoolingDown = false;
                    
                    if (!isMultipleChoice) {
                         const input = document.getElementById('answerInput');
                         if(input) {
                             input.classList.remove('incorrect-flash');
                             input.disabled = false;
                         }
                    }

                    // Generate new problem (which re-renders buttons/helper text)
                    if (state === 'GAME') { // Only load next problem if game is still running
                        nextProblem();
                    }
                }, COOLDOWN_TIME);
                // --- NEW PENALTY LOGIC END ---
            }
        }

        // --- DISPLAY UTILITIES ---

        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = `${timer}s`;
                if (timer <= 10) {
                    timerDisplay.classList.add('text-red-700', 'animate-pulse');
                } else {
                    timerDisplay.classList.remove('text-red-700', 'animate-pulse');
                }
            }
        }

        function updateScoreDisplay() {
            const scoreDisplay = document.getElementById('scoreDisplay');
            if (scoreDisplay) {
                scoreDisplay.textContent = `Score: ${score}`;
            }
        }

        // --- INITIALIZATION ---
        window.onload = renderSelectGrade;

    </script>
</body>
</html>