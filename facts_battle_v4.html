<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Fact Duel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom styles for the input box and flash effects */
        .correct-flash {
            box-shadow: 0 0 20px rgba(16, 185, 129, 1) !important; /* Green 500 */
        }
        .incorrect-flash {
            box-shadow: 0 0 20px rgba(239, 68, 68, 1) !important; /* Red 500 */
        }
        /* Custom slider track/thumb styling for aesthetics */
        input[type=range]::-webkit-slider-runnable-track {
            background: #9ca3af;
            height: 8px;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5;
            margin-top: -6px;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
            cursor: grab;
        }
        /* Custom styles for the purple slider track */
        #maxMultSlider::-webkit-slider-runnable-track {
            background: #a78bfa; /* purple-400 */
        }
        #maxMultSlider::-webkit-slider-thumb {
            background: #7c3aed; /* purple-600 */
        }
        /* Styles for the dual-player game area */
        .problem-container {
            min-height: 250px;
            /* Flex-center the penalty message */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .choice-button {
            transition: all 0.1s ease-in-out;
            -webkit-user-select: none;
            user-select: none; 
        }
        /* Make the main containers more responsive for mobile dueling */
        @media (max-width: 768px) {
            .dual-container {
                flex-direction: column;
            }
            .player-panel {
                margin-bottom: 1rem;
            }
            .problem-container {
                min-height: 150px;
            }
            .text-6xl {
                font-size: 4rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="appContainer" class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-5xl transition-all duration-300">
        <h1 class="text-4xl font-extrabold text-indigo-700 text-center mb-8">
            <span class="inline-block transform -rotate-6 text-yellow-500 mr-2">‚öîÔ∏è</span>
            Math Fact Duel
            <span class="inline-block transform rotate-6 text-green-500 ml-2">üß†</span>
        </h1>

        <div id="screenContainer">
            </div>
    </div>

    <script>
        // --- CONFIGURATION & STATE ---
        const activeOpsSelection = ['+', '-', '*', '/'];
        const COOLDOWN_TIME = 3000; // 3 seconds

        // Added isCoolingDown state for penalty logic
        let player1 = { name: 'Player 1', score: 0, attempted: 0, problem: {}, choices: [], color: 'bg-teal-500', problemId: 1, keys: ['A', 'S', 'D', 'F'], isCoolingDown: false };
        let player2 = { name: 'Player 2', score: 0, attempted: 0, problem: {}, choices: [], color: 'bg-orange-500', problemId: 2, keys: ['J', 'K', 'L', ';'], isCoolingDown: false }; 

        let timer = 0;
        let gameInterval = null;
        const GAME_DURATION = 60; // seconds
        let state = 'SETUP'; // SETUP | GAME | RESULTS

        // Difficulty State
        let maxFactValue = 20; 
        let maxMultValue = 12;

        const screenContainer = document.getElementById('screenContainer');

        // --- SOUND EFFECTS ---
        const correctSynth1 = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" } }).toDestination();
        const correctSynth2 = new Tone.PolySynth(Tone.MembraneSynth, { pitchDecay: 0.05, octave: 2 }).toDestination();
        const incorrectSynth = new Tone.NoiseSynth({
            noise: { type: "pink" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
        }).toDestination();
        const winSynth = new Tone.MembraneSynth().toDestination();
        const tieSynth = new Tone.PolySynth(Tone.AMSynth).toDestination();

        function playCorrectSound(playerId) { 
            if (playerId === 1) {
                correctSynth1.triggerAttackRelease(["G5", "C6"], "8n");
            } else {
                correctSynth2.triggerAttackRelease(["C4", "E4"], "8n");
            }
        }
        function playIncorrectSound() { incorrectSynth.triggerAttackRelease("16n"); }
        function playWinSound() { winSynth.triggerAttackRelease("C3", "0.5"); winSynth.triggerAttackRelease("G3", "0.5", Tone.now() + 0.3); }
        function playTieSound() { tieSynth.triggerAttackRelease(["C4", "E4", "G4"], "0.5"); }

        // --- PROBLEM GENERATION LOGIC (UNCHANGED) ---

        /**
         * Generates a random integer between min (inclusive) and max (exclusive).
         */
        function randInt(min, max) {
            return Math.floor(Math.random() * (max - min)) + min;
        }

        /**
         * Generates a math problem based on the operation list.
         */
        function generateProblem(opList) {
            const op = opList[randInt(0, opList.length)];
            let num1, num2, answer, problemText;

            if (op === '+' || op === '-') {
                const maxLimit = maxFactValue;
                
                if (op === '+') {
                    let sum;
                    do {
                        num1 = randInt(1, maxLimit); 
                        num2 = randInt(1, maxLimit);
                        sum = num1 + num2;
                    } while (sum > maxLimit); 
                    answer = sum;
                    problemText = `${num1} + ${num2} =`;
                } else { 
                    num1 = randInt(1, maxLimit + 1); 
                    num2 = randInt(0, num1); 
                    answer = num1 - num2;
                    problemText = `${num1} - ${num2} =`;
                }
            }
            else if (op === '*' || op === '/') {
                const maxFactor = maxMultValue;
                
                if (op === '*') {
                    num1 = randInt(0, maxFactor + 1);
                    num2 = randInt(0, maxFactor + 1);
                    answer = num1 * num2;
                    problemText = `${num1} √ó ${num2} =`;
                } else { 
                    const factor1 = randInt(1, maxFactor + 1);
                    const factor2 = randInt(1, maxFactor + 1);
                    const product = factor1 * factor2;

                    if (Math.random() < 0.5) {
                        num1 = product;
                        num2 = factor1;
                        answer = factor2;
                    } else {
                        num1 = product;
                        num2 = factor2;
                        answer = factor1;
                    }
                    problemText = `${num1} √∑ ${num2} =`;
                }
            }
            return { problemText, answer };
        }

        /**
         * Generates an array of four answer choices, including the correct one.
         */
        function generateChoices(correctAnswer) {
            const choices = new Set();
            choices.add(correctAnswer);

            while (choices.size < 4) {
                let distractor;
                const deviation = randInt(-4, 5); 
                distractor = correctAnswer + deviation;

                if (distractor >= 0 && !choices.has(distractor)) {
                    choices.add(distractor);
                }
                if (choices.size < 4 && correctAnswer < 5) {
                     distractor = randInt(0, 10);
                     if (distractor >= 0 && !choices.has(distractor)) choices.add(distractor);
                }
            }

            const choicesArray = Array.from(choices);
            for (let i = choicesArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [choicesArray[i], choicesArray[j]] = [choicesArray[j], choicesArray[i]];
            }

            return choicesArray;
        }

        // --- UI RENDERING FUNCTIONS (UNCHANGED) ---

        window.updateMaxFactValue = function(value) {
            maxFactValue = parseInt(value, 10);
            document.getElementById('maxFactValueDisplay').textContent = maxFactValue;
        }

        window.updateMaxMultValue = function(value) {
            maxMultValue = parseInt(value, 10);
            document.getElementById('maxMultValueDisplay').textContent = maxMultValue;
        }

        function renderSetupScreen() {
            screenContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Set Up Your Math Duel</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <input type="text" id="player1NameInput" 
                           value="${player1.name}" 
                           placeholder="Player 1 Name (A/S/D/F)"
                           class="p-4 text-center text-xl font-bold rounded-xl border-4 border-teal-400 focus:ring-4 focus:ring-teal-300">
                    
                    <input type="text" id="player2NameInput" 
                           value="${player2.name}" 
                           placeholder="Player 2 Name (J/K/L/ ;)"
                           class="p-4 text-center text-xl font-bold rounded-xl border-4 border-orange-400 focus:ring-4 focus:ring-orange-300">
                </div>
                
                <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Set Difficulty (All Four Operations)</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="p-4 rounded-xl bg-indigo-50 border border-indigo-200">
                        <label class="text-lg font-extrabold text-gray-800 mb-3 block">
                            Max A/S Fact Value: 
                            <span id="maxFactValueDisplay" class="text-indigo-600">${maxFactValue}</span>
                        </label>
                        <input type="range" id="maxFactSlider" min="5" max="20" step="1" 
                               value="${maxFactValue}" 
                               oninput="updateMaxFactValue(this.value)"
                               class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-sm text-gray-600 mt-1">
                            <span>5</span>
                            <span>20 (Max)</span>
                        </div>
                    </div>

                    <div class="p-4 rounded-xl bg-purple-50 border border-purple-200">
                        <label class="text-lg font-extrabold text-gray-800 mb-3 block">
                            Max M/D Factor: 
                            <span id="maxMultValueDisplay" class="text-purple-600">${maxMultValue}</span>
                        </label>
                        <input type="range" id="maxMultSlider" min="1" max="12" step="1" 
                               value="${maxMultValue}" 
                               oninput="updateMaxMultValue(this.value)"
                               class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-sm text-gray-600 mt-1">
                            <span>1 (Easy)</span>
                            <span>12 (Max)</span>
                        </div>
                    </div>
                </div>


                <button onclick="startGame()"
                        class="w-full py-4 bg-indigo-500 hover:bg-indigo-600 text-white font-extrabold text-2xl rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    START 60 SECOND DUEL
                </button>
            `;
            state = 'SETUP';
            document.removeEventListener('keydown', handleTwoPlayerInput);
        }

        function renderGame() {
            const p1Keys = player1.keys.join('/');
            const p2Keys = player2.keys.join('/');

            screenContainer.innerHTML = `
                <div class="flex justify-between items-center mb-6 p-4 bg-gray-100 rounded-lg shadow-inner">
                    <div id="scoreDisplay1" class="text-xl font-bold text-teal-600">Score: 0</div>
                    <div id="timerDisplay" class="text-4xl font-extrabold text-red-500">60s</div>
                    <div id="scoreDisplay2" class="text-xl font-bold text-orange-600">Score: 0</div>
                </div>

                <div class="grid grid-cols-2 gap-4 dual-container">
                    <div id="player1Container" class="p-4 rounded-xl border-4 border-teal-500 shadow-xl transition-all duration-300 player-panel">
                        <h3 class="text-2xl font-extrabold text-center text-teal-700 mb-4">${player1.name} (${p1Keys})</h3>
                        
                        <div id="problemContainer1" class="problem-container flex flex-col items-center justify-center p-4 bg-teal-50 rounded-xl shadow-md mb-4">
                            <p id="problemText1" class="text-6xl font-extrabold text-teal-800 mb-4 select-none">
                                </p>
                        </div>
                        
                        <div id="choicesContainer1" class="flex flex-row space-x-2">
                            </div>
                    </div>

                    <div id="player2Container" class="p-4 rounded-xl border-4 border-orange-500 shadow-xl transition-all duration-300 player-panel">
                        <h3 class="text-2xl font-extrabold text-center text-orange-700 mb-4">${player2.name} (${p2Keys})</h3>
                        
                        <div id="problemContainer2" class="problem-container flex flex-col items-center justify-center p-4 bg-orange-50 rounded-xl shadow-md mb-4">
                            <p id="problemText2" class="text-6xl font-extrabold text-orange-800 mb-4 select-none">
                                </p>
                        </div>
                        
                        <div id="choicesContainer2" class="flex flex-row space-x-2">
                            </div>
                    </div>
                </div>
            `;
            state = 'GAME';
            setupGameListeners();
        }

        function renderResults() {
            const p1 = player1;
            const p2 = player2;
            
            const p1Accuracy = p1.attempted > 0 ? ((p1.score / p1.attempted) * 100).toFixed(0) : 0;
            const p2Accuracy = p2.attempted > 0 ? ((p2.score / p2.attempted) * 100).toFixed(0) : 0;

            let winnerText = '';
            let winnerColor = 'text-gray-700';
            
            if (p1.score > p2.score) {
                winnerText = `${p1.name} WINS! üèÜ`;
                winnerColor = 'text-teal-600';
                playWinSound();
            } else if (p2.score > p1.score) {
                winnerText = `${p2.name} WINS! üèÜ`;
                winnerColor = 'text-orange-600';
                playWinSound();
            } else {
                winnerText = "IT'S A TIE! ü§ù";
                winnerColor = 'text-indigo-600';
                playTieSound();
            }

            screenContainer.innerHTML = `
                <h2 class="text-4xl font-extrabold text-center mb-6 ${winnerColor}">
                    ${winnerText}
                </h2>
                
                <p class="text-2xl font-bold text-center mb-10 text-gray-700">Final Score: ${p1.score} - ${p2.score}</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="p-6 rounded-xl border-4 border-teal-500 shadow-xl bg-teal-50 text-center">
                        <h3 class="text-3xl font-black text-teal-700 mb-4">${p1.name}</h3>
                        <p class="text-2xl font-bold text-green-700 mb-2">Correct Answers: ${p1.score}</p>
                        <p class="text-xl font-medium text-gray-800 mb-2">Total Attempted: ${p1.attempted}</p>
                        <hr class="my-4 border-teal-300">
                        <p class="text-2xl font-extrabold text-teal-800">Accuracy: ${p1Accuracy}%</p>
                    </div>

                    <div class="p-6 rounded-xl border-4 border-orange-500 shadow-xl bg-orange-50 text-center">
                        <h3 class="text-3xl font-black text-orange-700 mb-4">${p2.name}</h3>
                        <p class="text-2xl font-bold text-green-700 mb-2">Correct Answers: ${p2.score}</p>
                        <p class="text-xl font-medium text-gray-800 mb-2">Total Attempted: ${p2.attempted}</p>
                        <hr class="my-4 border-orange-300">
                        <p class="text-2xl font-extrabold text-orange-800">Accuracy: ${p2Accuracy}%</p>
                    </div>
                </div>

                <button onclick="renderSetupScreen()"
                        class="mt-4 w-full py-4 bg-indigo-500 hover:bg-indigo-600 text-white font-extrabold text-xl rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    Play Again!
                </button>
            `;
            state = 'RESULTS';
        }

        // --- GAME FLOW LOGIC ---

        window.startGame = function() {
            if (gameInterval) clearInterval(gameInterval);
            
            player1.name = document.getElementById('player1NameInput').value || 'Player 1';
            player2.name = document.getElementById('player2NameInput').value || 'Player 2';
            
            player1.score = 0; player1.attempted = 0; player1.isCoolingDown = false;
            player2.score = 0; player2.attempted = 0; player2.isCoolingDown = false;

            timer = GAME_DURATION;

            renderGame();
            updateTimerDisplay();
            
            nextProblem(player1);
            nextProblem(player2);

            gameInterval = setInterval(() => {
                timer--;
                updateTimerDisplay();
                if (timer <= 0) {
                    clearInterval(gameInterval);
                    renderResults();
                }
            }, 1000);
        }

        /**
         * Displays the next math problem for the given player.
         */
        function nextProblem(player) {
            const problem = generateProblem(activeOpsSelection);
            const choices = generateChoices(problem.answer);
            
            player.problem = problem;
            player.choices = choices;

            // Update problem text
            document.getElementById(`problemText${player.problemId}`).innerHTML = problem.problemText;
            
            const choicesContainer = document.getElementById(`choicesContainer${player.problemId}`);
            let buttonsHTML = '';

            const keys = player.keys;
            
            choices.forEach((choice, index) => {
                buttonsHTML += `
                    <button id="choice-${player.problemId}-${index}"
                            data-player="${player.problemId}"
                            data-choice-index="${index}"
                            onclick="handleButtonPress(${player.problemId}, ${index})"
                            class="choice-button flex-1 py-4 text-3xl font-bold ${player.problemId === 1 ? 'bg-teal-500 hover:bg-teal-600' : 'bg-orange-500 hover:bg-orange-600'} text-white rounded-xl shadow-lg transition duration-150 ease-in-out">
                        <span class="text-sm font-normal opacity-80 mr-1">${keys[index]}:</span> ${choice}
                    </button>
                `;
            });
            choicesContainer.innerHTML = buttonsHTML;
        }
        
        /**
         * Checks the user's answer via keyboard or button click.
         */
        function checkAnswer(player, choiceIndex) {
            // New check: Ignore input if player is currently in a cooldown state or game is over
            if (state !== 'GAME' || timer <= 0 || player.isCoolingDown) return;
            
            const currentProblem = player.problem;
            const userAnswer = player.choices[choiceIndex];
            const isCorrect = userAnswer === currentProblem.answer;

            player.attempted++;
            
            const playerContainer = document.getElementById(`player${player.problemId}Container`);
            const problemTextEl = document.getElementById(`problemText${player.problemId}`);
            const choicesContainer = document.getElementById(`choicesContainer${player.problemId}`);

            if (isCorrect) {
                playCorrectSound(player.problemId);
                player.score++;
                
                document.getElementById(`scoreDisplay${player.problemId}`).textContent = `Score: ${player.score}`;

                playerContainer.classList.add('correct-flash');
                setTimeout(() => playerContainer.classList.remove('correct-flash'), 200);

                setTimeout(() => nextProblem(player), 150);
            } else {
                playIncorrectSound();
                
                // --- PENALTY LOGIC START ---
                player.isCoolingDown = true;
                
                // Visual penalty feedback (red flash on container)
                playerContainer.classList.add('incorrect-flash');
                
                // Show the correct answer and a penalty message
                problemTextEl.innerHTML = `<span class="text-4xl font-bold text-red-500">‚ùå NOPE!</span><br><span class="text-5xl font-extrabold text-green-600">${currentProblem.problemText} ${currentProblem.answer}</span>`;
                
                // Disable all buttons for this player during cooldown
                const choiceButtons = choicesContainer.querySelectorAll('button');
                choiceButtons.forEach(btn => btn.disabled = true);

                // Set the cooldown timer
                setTimeout(() => {
                    // End of cooldown
                    player.isCoolingDown = false;
                    playerContainer.classList.remove('incorrect-flash');

                    // Generate new problem (which re-renders buttons)
                    nextProblem(player);
                }, COOLDOWN_TIME);
                // --- PENALTY LOGIC END ---
            }
        }
        
        // --- BUTTON PRESS HANDLER ---
        window.handleButtonPress = function(playerId, choiceIndex) {
            const player = playerId === 1 ? player1 : player2;
            // Input check inside checkAnswer()
            checkAnswer(player, choiceIndex);
        }

        /**
         * Maps keyboard keys to players and answer choices.
         */
        function handleTwoPlayerInput(event) {
            if (state !== 'GAME' || timer <= 0) return;
            
            const key = event.key.toLowerCase();
            let playerTarget = null;
            let choiceIndex = -1;

            switch (key) {
                // Player 1 (A/S/D/F)
                case 'a': playerTarget = player1; choiceIndex = 0; break;
                case 's': playerTarget = player1; choiceIndex = 1; break;
                case 'd': playerTarget = player1; choiceIndex = 2; break;
                case 'f': playerTarget = player1; choiceIndex = 3; break;

                // Player 2 (J/K/L/;)
                case 'j': playerTarget = player2; choiceIndex = 0; break;
                case 'k': playerTarget = player2; choiceIndex = 1; break;
                case 'l': playerTarget = player2; choiceIndex = 2; break;
                case ';': playerTarget = player2; choiceIndex = 3; break;
            }

            if (playerTarget && choiceIndex !== -1) {
                // New check: Do not process keyboard input if the player is cooling down
                if (playerTarget.isCoolingDown) return;
                
                event.preventDefault(); 
                checkAnswer(playerTarget, choiceIndex);
            }
        }

        /**
         * Sets up the keydown event listener.
         */
        function setupGameListeners() {
            document.removeEventListener('keydown', handleTwoPlayerInput);
            document.addEventListener('keydown', handleTwoPlayerInput);
        }

        // --- DISPLAY UTILITIES (UNCHANGED) ---

        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = `${timer}s`;
                if (timer <= 10) {
                    timerDisplay.classList.add('text-red-700', 'animate-pulse');
                } else {
                    timerDisplay.classList.remove('text-red-700', 'animate-pulse');
                }
            }
        }

        // --- INITIALIZATION ---
        document.documentElement.addEventListener('mousedown', () => {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
        });

        window.onload = renderSetupScreen;

    </script>
</body>
</html>