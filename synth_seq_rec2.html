<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educational Dual-VCO Synth & Sequencer v3 (Major Scale)</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            text-align: center;
            padding: 10px;
            background-color: #1a1a2e; /* Dark theme background */
            color: #e0e0e0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #2a2a40;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4); 
        }
        h2 { 
            color: #00ffff; 
            margin-bottom: 10px; 
            font-weight: 700;
        }
        
        /* Control Panel Layout */
        .controls-panel {
            display: grid;
            /* Changed to 2 columns for better mobile layout */
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 2px solid #555;
            margin-bottom: 20px;
        }
        .synth-section {
            padding: 15px;
            border: 1px solid #444466;
            border-radius: 8px;
            background-color: #333350;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            text-align: left;
        }
        .synth-section h3 { 
            margin-top: 0;
            color: #ff9800; /* Orange accent */
            font-size: 1.1em;
            text-align: center;
            border-bottom: 1px dashed #444466;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        /* Sliders and Labels */
        .control-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            font-size: 0.9em;
            margin-bottom: 3px;
            color: #b0b0b0;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #555;
            border-radius: 4px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #00ffff; /* Aqua knob */
            border-radius: 50%;
            border: 2px solid #2a2a40;
        }

        /* --- Keyboard Styling --- */
        .keyboard-area {
            grid-column: 1 / 3;
            text-align: center;
        }
        .keyboard-controls {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        #octave-selector {
            padding: 5px 10px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 4px;
        }

        .piano-keys {
            display: flex;
            justify-content: center;
            user-select: none;
            margin-top: 15px;
        }
        .key {
            width: 45px;
            min-width: 45px;
            height: 120px;
            background-color: white;
            border: 1px solid #333;
            margin-right: 1px;
            position: relative;
            box-shadow: 0 4px 0 #999;
            transition: all 0.05s ease;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-size: 10px;
            color: #333;
            z-index: 1;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
        }
        .key.black {
            background-color: #333;
            color: #eee;
            width: 30px;
            min-width: 30px;
            height: 80px;
            margin-left: -15px;
            margin-right: -15px;
            z-index: 2;
            box-shadow: 0 4px 0 #000;
        }
        .key.active {
            box-shadow: none;
            transform: translateY(4px);
            background-color: #00ffff; 
        }
        .key.black.active {
            background-color: #ff9800; 
        }

        /* --- Sequencer Styling (Fancier look) --- */
        .sequencer-container {
            grid-column: 1 / 3;
            padding: 15px;
            background: #151525;
            border-radius: 8px;
            margin-top: 20px;
        }
        .sequencer-grid {
            display: grid;
            /* 1 column for the note label (60px) + 16 columns for the steps (1fr) */
            grid-template-columns: 60px repeat(16, 1fr); 
            gap: 3px;
            padding: 5px;
            border-radius: 4px;
        }
        .note-label {
            /* Fix: Ensure the label only spans the first column */
            grid-column: 1 / 2; 
            text-align: right;
            padding-right: 5px;
            color: #aaa;
            font-size: 11px;
            height: 25px;
            line-height: 25px;
            font-weight: bold;
        }
        .step {
            width: 100%;
            height: 25px;
            background-color: #444466; 
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .step.on {
            background-color: #ff9800; /* Orange for ON */
        }
        .step.current {
            box-shadow: 0 0 10px 2px #00ffff; /* Aqua glow for current step */
            border: 2px solid #00ffff;
        }

        /* --- Recorder and Transport --- */
        .transport-controls {
            grid-column: 1 / 3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            gap: 15px;
        }
        .transport-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.1s, transform 0.1s;
        }
        .transport-controls button:hover {
            transform: translateY(-1px);
        }
        #play-btn { background-color: #4CAF50; color: white; }
        #stop-btn { background-color: #f44336; color: white; }
        #record-btn { background-color: #ff00ff; color: white; }
        #download-btn { background-color: #2196F3; color: white; }
        #clear-btn { background-color: #666; color: white; }

        @media (max-width: 768px) {
            .controls-panel {
                grid-template-columns: 1fr;
            }
            .transport-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            .transport-controls button {
                flex-grow: 1;
            }
            .keyboard-area, .sequencer-container, .transport-controls {
                grid-column: 1 / 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Educational Dual-VCO Synthesizer</h2>

        <div class="controls-panel">
            <!-- VCO 1 -->
            <div class="synth-section">
                <h3>VCO 1 (Voice 1)</h3>
                <div class="control-group">
                    <label for="vco1-wave">Waveform</label>
                    <select id="vco1-wave" onchange="updateVCO1Wave(this.value)">
                        <option value="sawtooth">Saw</option>
                        <option value="square">Square</option>
                        <option value="sine">Sine</option>
                        <option value="triangle">Triangle</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="vco1-level">Output Level: <span id="vco1-level-val">0.7</span></label>
                    <input type="range" id="vco1-level" min="0" max="1" step="0.01" value="0.7" oninput="document.getElementById('vco1-level-val').textContent = this.value">
                </div>
            </div>

            <!-- VCO 2 -->
            <div class="synth-section">
                <h3>VCO 2 (Voice 2)</h3>
                <div class="control-group">
                    <label for="vco2-wave">Waveform</label>
                    <select id="vco2-wave" onchange="updateVCO2Wave(this.value)">
                        <option value="sawtooth">Saw</option>
                        <option value="square">Square</option>
                        <option value="sine">Sine</option>
                        <option value="triangle">Triangle</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="vco2-level">Output Level: <span id="vco2-level-val">0.7</span></label>
                    <input type="range" id="vco2-level" min="0" max="1" step="0.01" value="0.7" oninput="document.getElementById('vco2-level-val').textContent = this.value">
                </div>
            </div>
            
            <!-- ADSR Envelope -->
            <div class="synth-section">
                <h3>ADSR Envelope</h3>
                <div class="control-group"><label>Attack: <span id="attack-val">0.05s</span></label><input type="range" id="attack" min="0.01" max="1.0" step="0.01" value="0.05" oninput="document.getElementById('attack-val').textContent = this.value + 's'"></div>
                <div class="control-group"><label>Decay: <span id="decay-val">0.2s</span></label><input type="range" id="decay" min="0.05" max="1.0" step="0.05" value="0.2" oninput="document.getElementById('decay-val').textContent = this.value + 's'"></div>
                <div class="control-group"><label>Sustain: <span id="sustain-val">0.5</span></label><input type="range" id="sustain" min="0" max="1" step="0.05" value="0.5" oninput="document.getElementById('sustain-val').textContent = this.value"></div>
                <div class="control-group"><label>Release: <span id="release-val">0.5s</span></label><input type="range" id="release" min="0.05" max="2.0" step="0.05" value="0.5" oninput="document.getElementById('release-val').textContent = this.value + 's'"></div>
            </div>

            <!-- VCF (Filter) -->
            <div class="synth-section">
                <h3>Filter (VCF)</h3>
                <div class="control-group"><label>Cutoff: <span id="cutoff-val">10000 Hz</span></label><input type="range" id="cutoff" min="50" max="15000" step="50" value="10000" oninput="document.getElementById('cutoff-val').textContent = this.value + ' Hz'"></div>
                <div class="control-group"><label>Resonance: <span id="res-val">1.0</span></label><input type="range" id="resonance" min="0.1" max="10" step="0.1" value="1.0" oninput="document.getElementById('res-val').textContent = this.value"></div>
            </div>

            <!-- QWERTY Keyboard Area -->
            <div class="keyboard-area">
                <div class="keyboard-controls">
                    <label for="octave-selector">Base Octave:</label>
                    <select id="octave-selector" onchange="updateBaseOctave(this.value)">
                        <option value="48">C3</option>
                        <option value="60" selected>C4</option>
                        <option value="72">C5</option>
                        <option value="84">C6</option>
                    </select>
                </div>
                <div id="piano-keys" class="piano-keys">
                    <!-- Keys generated here -->
                </div>
            </div>

            <!-- Sequencer -->
            <div class="sequencer-container">
                <h3>16-Step Sequencer (C Major Scale)</h3>
                <div id="sequencer-grid" class="sequencer-grid">
                    <!-- Grid generated here -->
                </div>
            </div>
            
            <!-- Transport Controls -->
            <div class="transport-controls">
                <input type="number" id="bpm-input" min="60" max="240" value="120" style="width:80px; padding: 10px; border-radius: 6px; border: 1px solid #555; background: #2b2b2b; color: white;">
                <button id="play-btn" onclick="startStopSequencer()">PLAY</button>
                <button id="stop-btn" onclick="stopSequencer()">STOP</button>
                <button id="record-btn" onclick="startStopRecording()">REC (Placeholder)</button>
                <button id="download-btn" onclick="downloadRecording()" disabled>Download WAV (Placeholder)</button>
                <button id="clear-btn" onclick="clearGrid()">Clear Sequence</button>
            </div>
        </div>
    </div>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        // --- Global State ---
        let currentStep = 0;
        let isPlaying = false;
        let sequencerInterval = null;
        let isRecording = false;
        let baseOctave = 60; // Default C4 (MIDI note 60)
        let vco1Wave = 'sawtooth';
        let vco2Wave = 'sawtooth';

        // --- SEQUENCER CONFIGURATION (C MAJOR SCALE) ---
        const MAJOR_SCALE_MIDI_OFFSETS = [0, 2, 4, 5, 7, 9, 11, 12]; // C, D, E, F, G, A, B, C
        const MAJOR_SCALE_NAMES = ["C5", "B4", "A4", "G4", "F4", "E4", "D4", "C4"].reverse(); // C4 to C5
        const NUM_ROWS = MAJOR_SCALE_MIDI_OFFSETS.length; // 8 notes
        const NUM_STEPS = 16;
        const NOTE_START_MIDI = 60; // C4

        // Sequence Data (Row: Note, Col: Step, Value: true/false)
        let sequence = Array(NUM_ROWS).fill(0).map(() => Array(NUM_STEPS).fill(false));

        // --- QWERTY KEY MAPPING (Chromatic Single Octave for Manual Play) ---
        const KEY_MAP = {
            'a': 0, 'w': 1, 's': 2, 'e': 3, 'd': 4, 'f': 5, 't': 6, 'g': 7, 'y': 8, 'h': 9, 'u': 10, 'j': 11, 'k': 12
        };
        const pressedKeys = {}; 

        // --- Voice Tracking (Stuck Note Fix) ---
        const activeVoices = {}; 

        // --- Utility Functions ---

        function midiToFreq(midiNote) {
            return 440 * Math.pow(2, (midiNote - 69) / 12);
        }

        // --- Audio Functions ---

        function getADSRParams() {
            return {
                attack: parseFloat(document.getElementById('attack').value),
                decay: parseFloat(document.getElementById('decay').value),
                sustain: parseFloat(document.getElementById('sustain').value),
                release: parseFloat(document.getElementById('release').value),
            };
        }

        function getVCFParams() {
             return {
                cutoff: parseFloat(document.getElementById('cutoff').value),
                resonance: parseFloat(document.getElementById('resonance').value)
            };
        }
        
        function getVCOLevels() {
            return {
                vco1Level: parseFloat(document.getElementById('vco1-level').value),
                vco2Level: parseFloat(document.getElementById('vco2-level').value)
            };
        }

        function updateVCO1Wave(wave) { vco1Wave = wave; }
        function updateVCO2Wave(wave) { vco2Wave = wave; }
        
        function updateBaseOctave(octaveMidi) { 
            baseOctave = parseInt(octaveMidi);
            createPianoKeys(); // Re-create the visual keyboard with new labels
        }


        function startNote(midiNote) {
            const now = audioCtx.currentTime;
            if (audioCtx.state !== 'running') { audioCtx.resume(); }

            const adsr = getADSRParams();
            const vcf = getVCFParams();
            const { vco1Level, vco2Level } = getVCOLevels();
            const freq = midiToFreq(midiNote);

            // 1. VCOs
            const vco1Node = audioCtx.createOscillator();
            vco1Node.type = vco1Wave;
            vco1Node.frequency.setValueAtTime(freq, now);

            const vco2Node = audioCtx.createOscillator();
            vco2Node.type = vco2Wave;
            vco2Node.frequency.setValueAtTime(freq, now);

            // 2. VCO Gain/Mixer
            const vco1Gain = audioCtx.createGain();
            vco1Gain.gain.setValueAtTime(vco1Level, now);
            
            const vco2Gain = audioCtx.createGain();
            vco2Gain.gain.setValueAtTime(vco2Level, now);

            // 3. VCF (Filter)
            const vcfNode = audioCtx.createBiquadFilter();
            vcfNode.type = 'lowpass';
            vcfNode.frequency.setValueAtTime(vcf.cutoff, now);
            vcfNode.Q.setValueAtTime(vcf.resonance, now);

            // 4. Master Envelope/VCA
            const noteGain = audioCtx.createGain();

            // ADSR Envelope Logic
            noteGain.gain.setValueAtTime(0.0001, now);
            noteGain.gain.linearRampToValueAtTime(1.0, now + adsr.attack); 
            noteGain.gain.setTargetAtTime(adsr.sustain, now + adsr.attack, adsr.decay / 5); 

            // 5. Connections
            vco1Node.connect(vco1Gain);
            vco2Node.connect(vco2Gain);

            vco1Gain.connect(vcfNode);
            vco2Gain.connect(vcfNode); // Both connect to filter

            vcfNode.connect(noteGain);
            noteGain.connect(audioCtx.destination); // Connect to speaker

            // 6. Start Oscillators
            vco1Node.start(now);
            vco2Node.start(now);

            // 7. Track Voice
            const voice = { vco1Node, vco2Node, noteGain, midiNote }; 
            if (!activeVoices[midiNote]) { activeVoices[midiNote] = []; }
            activeVoices[midiNote].push(voice);
            
            return voice;
        }

        function stopNote(midiNote) {
            const now = audioCtx.currentTime;
            const adsr = getADSRParams();
            
            const voices = activeVoices[midiNote];
            if (!voices || voices.length === 0) return;

            // Get the voice that was most recently started
            const voice = voices.pop(); 
            
            // RELEASE Phase
            voice.noteGain.gain.cancelScheduledValues(now);
            voice.noteGain.gain.setValueAtTime(voice.noteGain.gain.value, now);
            voice.noteGain.gain.exponentialRampToValueAtTime(0.0001, now + adsr.release);

            // Stop both oscillators after the release time
            voice.vco1Node.stop(now + adsr.release);
            voice.vco2Node.stop(now + adsr.release);
            
            // Cleanup: delete the key if the array is empty
            if (activeVoices[midiNote].length === 0) {
                delete activeVoices[midiNote];
            }
        }

        // --- Keyboard Functions ---

        function noteOn(midiNote) {
            // Highlight visual key
            const keyElement = document.querySelector(`.key[data-midi="${midiNote}"]`);
            if (keyElement) { keyElement.classList.add('active'); }
            startNote(midiNote);
        }

        function noteOff(midiNote) {
            const keyElement = document.querySelector(`.key[data-midi="${midiNote}"]`);
            if (keyElement) {
                // Remove highlight only if this is the last voice for this note
                if (!activeVoices[midiNote] || activeVoices[midiNote].length === 1) {
                    keyElement.classList.remove('active');
                }
            }
            stopNote(midiNote);
        }

        function createPianoKeys() {
            const keyboard = document.getElementById('piano-keys');
            keyboard.innerHTML = '';
            
            const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            const NUM_KEYS = 13; // One octave + C

            for (let i = 0; i < NUM_KEYS; i++) { 
                const midiNote = baseOctave + i;
                const noteValue = i % 12; 
                const noteName = noteNames[noteValue];
                
                const key = document.createElement('div');
                key.className = 'key';
                key.dataset.midi = midiNote;
                
                // Display the note name and octave number for C notes
                const octaveNum = Math.floor(baseOctave / 12) + Math.floor(i / 12);
                if (noteValue === 0 || i === 7) { // Also label G to help students orient
                     key.textContent = noteName + octaveNum;
                } else {
                     key.textContent = noteName;
                }

                // Determine black or white key
                if ([1, 3, 6, 8, 10].includes(noteValue)) {
                    key.classList.add('black');
                }
                
                // Mouse Listeners
                key.addEventListener('mousedown', () => noteOn(midiNote));
                key.addEventListener('mouseup', () => noteOff(midiNote)); 
                key.addEventListener('mouseleave', () => {
                    // Check if mouse is down and then released outside
                    if (key.classList.contains('active')) {
                        noteOff(midiNote);
                    }
                });

                keyboard.appendChild(key);
            }
        }

        // QWERTY Keyboard Event Handling
        document.addEventListener('keydown', (e) => {
            const keyChar = e.key.toLowerCase();
            const noteOffset = KEY_MAP[keyChar];
            
            if (noteOffset !== undefined && !pressedKeys[keyChar]) {
                e.preventDefault();
                const midiNote = baseOctave + noteOffset;
                noteOn(midiNote);
                pressedKeys[keyChar] = midiNote; 
            }
        });

        document.addEventListener('keyup', (e) => {
            const keyChar = e.key.toLowerCase();
            const midiNote = pressedKeys[keyChar];
            
            if (midiNote !== undefined) {
                e.preventDefault();
                noteOff(midiNote);
                delete pressedKeys[keyChar];
            }
        });

        // --- Sequencer Functions ---

        function createGrid() {
            const sequencerGrid = document.getElementById('sequencer-grid');
            sequencerGrid.innerHTML = '';
            
            // Create the 8 Note Labels (C4 to C5 Major Scale)
            // Loop through the MAJOR_SCALE_NAMES array (C5 down to C4)
            for (let row = 0; row < NUM_ROWS; row++) {
                const name = MAJOR_SCALE_NAMES[row];
                
                // Add the note label element (first column)
                const label = document.createElement('div');
                label.className = 'note-label';
                label.textContent = name;
                sequencerGrid.appendChild(label);

                // Add the 16 step elements (columns 2-17)
                for (let col = 0; col < NUM_STEPS; col++) {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'step';
                    stepElement.dataset.row = row;
                    stepElement.dataset.col = col;
                    
                    stepElement.onclick = () => {
                        sequence[row][col] = !sequence[row][col];
                        stepElement.classList.toggle('on', sequence[row][col]);
                    };
                    
                    // Set initial state from sequence data
                    if (sequence[row][col]) {
                        stepElement.classList.add('on');
                    }
                    
                    sequencerGrid.appendChild(stepElement);
                }
            }
        }
        
        function clearGrid() {
            // Reinitialize sequence array
            sequence = Array(NUM_ROWS).fill(0).map(() => Array(NUM_STEPS).fill(false));
            document.querySelectorAll('.step').forEach(el => el.classList.remove('on'));
        }

        function runStep() {
            const bpm = parseInt(document.getElementById('bpm-input').value) || 120;
            const stepDuration = 60 / bpm / 4; // 16th note duration
            
            // Clear current step highlight
            document.querySelectorAll('.step.current').forEach(el => el.classList.remove('current'));

            // Play notes for the current step
            for (let row = 0; row < NUM_ROWS; row++) {
                if (sequence[row][currentStep]) {
                    // Calculate MIDI note: C4 (60) + offset from the MAJOR_SCALE_MIDI_OFFSETS
                    // We use (NUM_ROWS - 1 - row) to get the index that corresponds to C4 (row 7) up to C5 (row 0)
                    const scaleIndex = NUM_ROWS - 1 - row;
                    const midiNote = NOTE_START_MIDI + MAJOR_SCALE_MIDI_OFFSETS[scaleIndex]; 
                    
                    startNote(midiNote);
                    setTimeout(() => stopNote(midiNote), stepDuration * 1000 * 0.9); // Release slightly before next step
                }
            }
            
            // Highlight the new current step (across all rows for the current column)
            document.querySelectorAll(`[data-col="${currentStep}"]`).forEach(el => {
                el.classList.add('current');
            });

            currentStep = (currentStep + 1) % NUM_STEPS;
        }

        function startStopSequencer() {
            if (isPlaying) {
                stopSequencer();
                document.getElementById('play-btn').textContent = 'PLAY';
            } else {
                isPlaying = true;
                currentStep = 0;
                document.getElementById('play-btn').textContent = 'PAUSE';

                const bpm = parseInt(document.getElementById('bpm-input').value) || 120;
                const intervalTime = (60 / bpm / 4) * 1000;

                runStep(); // Run the first step immediately
                sequencerInterval = setInterval(runStep, intervalTime);
            }
        }

        function stopSequencer() {
            isPlaying = false;
            clearInterval(sequencerInterval);
            document.getElementById('play-btn').textContent = 'PLAY';
            document.querySelectorAll('.step.current').forEach(el => el.classList.remove('current'));
            // Ensure all notes are cleanly off
            Object.keys(activeVoices).forEach(note => {
                while(activeVoices[note] && activeVoices[note].length > 0) {
                    stopNote(parseInt(note));
                }
            });
        }

        // --- WAV Recorder Functions (Placeholders) ---

        function startStopRecording() {
            // This is a placeholder for the start/stop recording button.
            // Actual WAV recording in this environment is complex and unreliable.
            if (!isRecording) {
                isRecording = true;
                document.getElementById('record-btn').style.backgroundColor = 'red';
                document.getElementById('record-btn').textContent = 'RECORDING...';
                document.getElementById('download-btn').disabled = true;
                console.log("Recording started (Placeholder)");
            } else {
                isRecording = false;
                document.getElementById('record-btn').style.backgroundColor = '#ff00ff';
                document.getElementById('record-btn').textContent = 'REC (Placeholder)';
                document.getElementById('download-btn').disabled = false;
                console.log("Recording stopped (Placeholder). Download enabled.");
            }
        }

        function downloadRecording() {
            // This creates a placeholder 1-second silent WAV file.
            const sampleRate = 44100;
            const duration = 1; 
            const numSamples = sampleRate * duration;
            const audioBuffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(audioBuffer);
            const dataOffset = 44;

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + numSamples * 2, true); 
            writeString(view, 8, 'WAVE');
            
            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); 
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); 
            view.setUint16(32, 2, true); 
            view.setUint16(34, 16, true); 

            // Data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, numSamples * 2, true); 

            // Write silence
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(dataOffset + i * 2, 0, true);
            }

            const blob = new Blob([view], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'synth_recording_placeholder.wav';
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            createPianoKeys(); 
            createGrid(); 
            
            // Set initial state for select elements
            document.getElementById('vco1-wave').value = vco1Wave;
            document.getElementById('vco2-wave').value = vco2Wave;
        });

    </script>
</body>
</html>
