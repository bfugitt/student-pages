<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MacLatin v2.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f0f0;
            --window-bg: #ffffff;
            --border-color: #000000;
            --highlight: #000000;
            --text-color: #000000;
        }

        /* --- Mac System 6 Aesthetic --- */
        body {
            font-family: 'VT323', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ccc 75%), 
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 4px 4px;
            font-size: 20px;
            overscroll-behavior: none;
        }

        .window {
            background: var(--window-bg);
            border: 2px solid var(--border-color);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .title-bar {
            background: repeating-linear-gradient(
                0deg,
                #fff,
                #fff 2px,
                #000 2px,
                #000 4px
            );
            height: 30px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
        }

        .title-box {
            background: #fff;
            padding: 0 10px;
            font-weight: bold;
            font-size: 1.2rem;
            border-left: 2px solid #000;
            border-right: 2px solid #000;
        }

        .content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 400px; /* Increased for MacMan canvas */
        }

        /* --- Controls & Inputs --- */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        label {
            font-weight: bold;
            text-transform: uppercase;
        }

        select, input[type="text"] {
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            padding: 8px;
            border: 2px solid #000;
            background: #fff;
            border-radius: 0;
            width: 100%;
            box-sizing: border-box;
        }

        /* --- Buttons --- */
        .btn {
            font-family: 'VT323', monospace;
            background: #fff;
            border: 2px solid #000;
            padding: 10px 20px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 2px 2px 0 #000;
            text-align: center;
            transition: transform 0.1s, box-shadow 0.1s;
            touch-action: manipulation;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 0 0 0 #000;
            background: #000;
            color: #fff;
        }

        .btn-block { width: 100%; }
        .btn-small { font-size: 1rem; padding: 5px 10px; }

        .btn.selected {
            background: #000;
            color: #fff;
            box-shadow: inset 2px 2px 0 #555;
        }

        /* --- Game Screens --- */
        .screen {
            display: none;
            height: 100%;
            flex-direction: column;
            justify-content: space-between;
        }

        .screen.active { display: flex; }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Standard Quiz UI */
        .question-box { text-align: center; margin: 20px 0; }
        .question-word { font-size: 2.5rem; font-weight: bold; display: block; margin-bottom: 10px; }
        .question-context { font-size: 1rem; font-style: italic; color: #444; }
        .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* MacMan UI */
        .macman-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        #macman-canvas {
            border: 2px solid #000;
            background: #fff;
        }
        .word-display {
            font-size: 2rem;
            letter-spacing: 5px;
            font-weight: bold;
            min-height: 40px;
        }
        .keyboard-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            width: 100%;
        }
        .key-btn {
            padding: 8px 0;
            font-size: 1.2rem;
            min-width: 0;
        }

        /* Gender Sort UI */
        .folder-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .folder-btn {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px 10px 0 0; /* Folder tab look */
            flex-direction: column;
        }
        .folder-icon { font-size: 2rem; margin-bottom: 5px; }

        @media (max-width: 450px) {
            .choices-grid { grid-template-columns: 1fr; }
            .keyboard-grid { grid-template-columns: repeat(6, 1fr); }
        }

        /* Feedback & Logs */
        .feedback-area {
            min-height: 30px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }
        .correct { color: #000; text-decoration: underline; }
        .incorrect { color: #fff; background: #000; display: inline-block; padding: 0 5px;}

        .log-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #000;
            padding: 5px;
            margin-bottom: 15px;
            list-style: none;
        }
        .log-list li {
            border-bottom: 1px dotted #ccc;
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }

        /* Activity Selectors */
        .activity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .activity-btn {
            padding: 15px 5px;
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* Icon placeholders */
        .icon-lg { font-size: 1.5rem; }

    </style>
</head>
<body>

<div class="window">
    <div class="title-bar">
        <div class="title-box">MacLatin v2.0</div>
    </div>
    
    <div class="content">
        
        <!-- === START SCREEN === -->
        <div id="start-screen" class="screen active">
            <div style="text-align: center; margin-bottom: 10px;">
                <h2>SELECT ACTIVITY</h2>
            </div>

            <!-- Activity Selection -->
            <div class="activity-grid">
                <button class="btn activity-btn selected" id="btn-act-quiz" onclick="setActivity('quiz')">
                    <span class="icon-lg">?</span>
                    Quiz
                </button>
                <button class="btn activity-btn" id="btn-act-macman" onclick="setActivity('macman')">
                    <span class="icon-lg">ÏõÉ</span>
                    MacMan
                </button>
                <button class="btn activity-btn" id="btn-act-sort" onclick="setActivity('sort')">
                    <span class="icon-lg">üóÇÔ∏è</span>
                    Sort
                </button>
            </div>

            <!-- Settings -->
            <div class="control-group">
                <label>Chapters:</label>
                <select id="chapter-select">
                    <option value="all">All Chapters (1-7)</option>
                    <option value="1">Chapter 1</option>
                    <option value="2">Chapter 2</option>
                    <option value="3">Chapter 3</option>
                    <option value="4">Chapter 4</option>
                    <option value="5">Chapter 5</option>
                    <option value="6">Chapter 6</option>
                    <option value="7">Chapter 7</option>
                </select>
            </div>

            <!-- Dynamic Settings Area -->
            <div id="quiz-settings">
                <div class="control-group">
                    <label>Mode:</label>
                    <select id="mode-select">
                        <option value="multiple">Multiple Choice</option>
                        <option value="type">Type Answer</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Direction:</label>
                    <select id="direction-select">
                        <option value="lat-eng">Latin &rarr; English</option>
                        <option value="eng-lat">English &rarr; Latin</option>
                    </select>
                </div>
            </div>

            <!-- Saved Data Notification -->
            <div id="saved-data-notice" style="display:none; margin-top: 10px;">
                <button class="btn btn-block" style="border: 2px dashed #000;" onclick="reviewSavedMissed()">
                    REVIEW SAVED MISSED ITEMS
                </button>
            </div>

            <div style="margin-top: auto;">
                <button class="btn btn-block" onclick="startGame(false)">START</button>
            </div>
        </div>

        <!-- === QUIZ SCREEN === -->
        <div id="quiz-screen" class="screen">
            <div class="stats-bar">
                <span id="quiz-score">Score: 0</span>
                <span id="quiz-progress">1 / 10</span>
            </div>
            <div class="question-box">
                <span id="quiz-word" class="question-word">...</span>
                <span id="quiz-hint" class="question-context"></span>
            </div>
            <div id="quiz-input-area"></div>
            <div id="quiz-feedback" class="feedback-area"></div>
            <div style="margin-top: auto; display: flex; gap: 10px;">
                <button class="btn btn-small" onclick="quitGame()">Quit</button>
            </div>
        </div>

        <!-- === MACMAN SCREEN === -->
        <div id="macman-screen" class="screen">
            <div class="stats-bar">
                <span id="mm-score">Wins: 0</span>
                <span>MacMan</span>
            </div>
            <div class="macman-container">
                <canvas id="macman-canvas" width="150" height="150"></canvas>
                <div id="mm-word" class="word-display">_ _ _ _ _</div>
                <div id="mm-hint" style="font-style: italic;"></div>
            </div>
            <div id="mm-keyboard" class="keyboard-grid" style="margin-top: 20px;">
                <!-- Keys generated via JS -->
            </div>
            <div id="mm-feedback" class="feedback-area"></div>
            <div style="margin-top: auto;">
                 <button class="btn btn-small" onclick="quitGame()">Quit</button>
            </div>
        </div>

        <!-- === GENDER SORT SCREEN === -->
        <div id="sort-screen" class="screen">
             <div class="stats-bar">
                <span id="sort-score">Score: 0</span>
                <span id="sort-timer">Time: --</span>
            </div>
            <div class="question-box">
                <span style="font-size: 1.2rem;">Sort by Gender:</span>
                <span id="sort-word" class="question-word" style="margin-top: 10px;">...</span>
                <span id="sort-def" class="question-context"></span>
            </div>
            
            <div class="folder-container">
                <button class="btn folder-btn" onclick="checkSort('m')">
                    <span class="folder-icon">M</span>
                    Masc
                </button>
                <button class="btn folder-btn" onclick="checkSort('f')">
                    <span class="folder-icon">F</span>
                    Fem
                </button>
                <button class="btn folder-btn" onclick="checkSort('n')">
                    <span class="folder-icon">N</span>
                    Neut
                </button>
            </div>
            <div id="sort-feedback" class="feedback-area"></div>
             <div style="margin-top: auto;">
                 <button class="btn btn-small" onclick="quitGame()">Quit</button>
            </div>
        </div>

        <!-- === RESULTS SCREEN === -->
        <div id="result-screen" class="screen">
            <div style="text-align: center;">
                <h2>SESSION COMPLETE</h2>
                <h1 id="final-score">85%</h1>
                <p id="result-message">Good job!</p>
            </div>

            <div id="missed-container" style="display: none;">
                <label>Missed Items (Saved):</label>
                <ul id="log-list" class="log-list"></ul>
                <button class="btn btn-block" onclick="reviewMissedImmediately()">REVIEW NOW</button>
            </div>

            <div style="margin-top: 15px;">
                <button class="btn btn-block" onclick="showStartScreen()">MAIN MENU</button>
            </div>
        </div>

    </div>
</div>

<script>
    // --- DATABASE ---
    const VOCAB_DB = [
        // CHAPTER 1
        { ch: 1, lat: "agricola", eng: "farmer", gender: "m" },
        { ch: 1, lat: "aqua", eng: "water", gender: "f" },
        { ch: 1, lat: "athleta", eng: "athlete", gender: "m" },
        { ch: 1, lat: "filia", eng: "daughter", gender: "f" },
        { ch: 1, lat: "lupa", eng: "she-wolf", gender: "f" },
        { ch: 1, lat: "nauta", eng: "sailor", gender: "m" },
        { ch: 1, lat: "poeta", eng: "poet", gender: "m" },
        { ch: 1, lat: "puella", eng: "girl", gender: "f" },
        { ch: 1, lat: "Roma", eng: "Rome", gender: "f" },
        { ch: 1, lat: "terra", eng: "land", gender: "f" },
        { ch: 1, lat: "amat", eng: "he/she/it loves" },
        { ch: 1, lat: "ambulat", eng: "he/she/it walks" },
        { ch: 1, lat: "curat", eng: "he/she/it takes care of" },
        { ch: 1, lat: "est", eng: "he/she/it is" },
        { ch: 1, lat: "bene", eng: "well" },
        { ch: 1, lat: "postea", eng: "afterwards" },
        { ch: 1, lat: "et", eng: "and" },
        { ch: 1, lat: "itaque", eng: "and so" },
        // CHAPTER 2
        { ch: 2, lat: "fabula", eng: "story", gender: "f" },
        { ch: 2, lat: "forma", eng: "form", gender: "f" },
        { ch: 2, lat: "patria", eng: "fatherland", gender: "f" },
        { ch: 2, lat: "amo", eng: "to love" },
        { ch: 2, lat: "ambulo", eng: "to walk" },
        { ch: 2, lat: "curo", eng: "to care for" },
        { ch: 2, lat: "debeo", eng: "ought" },
        { ch: 2, lat: "exspecto", eng: "to wait for" },
        { ch: 2, lat: "habeo", eng: "to have" },
        { ch: 2, lat: "habito", eng: "to live" },
        { ch: 2, lat: "narro", eng: "to tell" },
        { ch: 2, lat: "paro", eng: "to prepare" },
        { ch: 2, lat: "teneo", eng: "to hold" },
        { ch: 2, lat: "video", eng: "to see" },
        { ch: 2, lat: "voco", eng: "to call" },
        { ch: 2, lat: "diu", eng: "for a long time" },
        { ch: 2, lat: "nunc", eng: "now" },
        { ch: 2, lat: "non", eng: "not" },
        // CHAPTER 3
        { ch: 3, lat: "ager", eng: "field", gender: "m" },
        { ch: 3, lat: "amicus", eng: "friend", gender: "m" },
        { ch: 3, lat: "animus", eng: "spirit", gender: "m" },
        { ch: 3, lat: "casa", eng: "little house", gender: "f" },
        { ch: 3, lat: "domi", eng: "at home" },
        { ch: 3, lat: "filius", eng: "son", gender: "m" },
        { ch: 3, lat: "puer", eng: "boy", gender: "m" },
        { ch: 3, lat: "rivus", eng: "brook", gender: "m" },
        { ch: 3, lat: "via", eng: "road", gender: "f" },
        { ch: 3, lat: "vir", eng: "man", gender: "m" },
        { ch: 3, lat: "ego", eng: "I" },
        { ch: 3, lat: "tu", eng: "you" },
        { ch: 3, lat: "timeo", eng: "to fear" },
        { ch: 3, lat: "deinde", eng: "then" },
        { ch: 3, lat: "valde", eng: "very" },
        { ch: 3, lat: "cum", eng: "with" },
        { ch: 3, lat: "in", eng: "in" },
        // CHAPTER 4
        { ch: 4, lat: "bellum", eng: "war", gender: "n" },
        { ch: 4, lat: "castra", eng: "camp", gender: "n" },
        { ch: 4, lat: "dolus", eng: "trickery", gender: "m" },
        { ch: 4, lat: "praemium", eng: "reward", gender: "n" },
        { ch: 4, lat: "venenum", eng: "poison", gender: "n" },
        { ch: 4, lat: "vinculum", eng: "chain", gender: "n" },
        { ch: 4, lat: "bonus", eng: "good" },
        { ch: 4, lat: "armatus", eng: "armed" },
        { ch: 4, lat: "iustus", eng: "just" },
        { ch: 4, lat: "magnus", eng: "large" },
        { ch: 4, lat: "malus", eng: "bad" },
        { ch: 4, lat: "praeclarus", eng: "famous" },
        { ch: 4, lat: "Romanus", eng: "Roman" },
        { ch: 4, lat: "do", eng: "to give" },
        { ch: 4, lat: "intro", eng: "to enter" },
        { ch: 4, lat: "iubeo", eng: "to order" },
        { ch: 4, lat: "ad", eng: "towards" },
        { ch: 4, lat: "e/ex", eng: "from" },
        // CHAPTER 5
        { ch: 5, lat: "auxilium", eng: "help", gender: "n" },
        { ch: 5, lat: "consilium", eng: "plan", gender: "n" },
        { ch: 5, lat: "epistula", eng: "letter", gender: "f" },
        { ch: 5, lat: "familia", eng: "family", gender: "f" },
        { ch: 5, lat: "gaudium", eng: "joy", gender: "n" },
        { ch: 5, lat: "lacrima", eng: "tear", gender: "f" },
        { ch: 5, lat: "longus", eng: "long" },
        { ch: 5, lat: "miser", eng: "wretched" },
        { ch: 5, lat: "pulcher", eng: "beautiful" },
        { ch: 5, lat: "cogito", eng: "to think" },
        { ch: 5, lat: "doleo", eng: "to feel pain" },
        { ch: 5, lat: "longe", eng: "far" },
        { ch: 5, lat: "semper", eng: "always" },
        { ch: 5, lat: "a/ab", eng: "by/from" },
        { ch: 5, lat: "de", eng: "about" },
        { ch: 5, lat: "nam", eng: "for" },
        { ch: 5, lat: "non solum", eng: "not only" },
        { ch: 5, lat: "sed etiam", eng: "but also" },
        { ch: 5, lat: "tamen", eng: "however" },
        // CHAPTER 6
        { ch: 6, lat: "exemplum", eng: "example", gender: "n" },
        { ch: 6, lat: "liber", eng: "book", gender: "m" },
        { ch: 6, lat: "littera", eng: "letter (alphabet)", gender: "f" },
        { ch: 6, lat: "memoria", eng: "memory", gender: "f" },
        { ch: 6, lat: "tenebrae", eng: "shadows", gender: "f" },
        { ch: 6, lat: "vita", eng: "life", gender: "f" },
        { ch: 6, lat: "multus", eng: "much" },
        { ch: 6, lat: "doceo", eng: "to teach" },
        { ch: 6, lat: "firmo", eng: "to strengthen" },
        { ch: 6, lat: "iaceo", eng: "to lie down" },
        { ch: 6, lat: "iudico", eng: "to judge" },
        { ch: 6, lat: "maneo", eng: "to remain" },
        { ch: 6, lat: "possum", eng: "to be able" },
        { ch: 6, lat: "servo", eng: "to save" },
        { ch: 6, lat: "soleo", eng: "to be accustomed" },
        { ch: 6, lat: "sum", eng: "to be" },
        { ch: 6, lat: "saepe", eng: "often" },
        { ch: 6, lat: "propter", eng: "because of" },
        { ch: 6, lat: "dum", eng: "while" },
        // CHAPTER 7
        { ch: 7, lat: "amor", eng: "love", gender: "m" },
        { ch: 7, lat: "deliciae", eng: "delight", gender: "f" },
        { ch: 7, lat: "digitus", eng: "finger", gender: "m" },
        { ch: 7, lat: "domina", eng: "mistress", gender: "f" },
        { ch: 7, lat: "gremium", eng: "lap", gender: "n" },
        { ch: 7, lat: "oculus", eng: "eye", gender: "m" },
        { ch: 7, lat: "passer", eng: "sparrow", gender: "m" },
        { ch: 7, lat: "pax", eng: "peace", gender: "f" },
        { ch: 7, lat: "senex", eng: "old man", gender: "m" },
        { ch: 7, lat: "soror", eng: "sister", gender: "f" },
        { ch: 7, lat: "verbum", eng: "word", gender: "n" },
        { ch: 7, lat: "se", eng: "reflexive pronoun" },
        { ch: 7, lat: "meus", eng: "my" },
        { ch: 7, lat: "severus", eng: "strict" },
        { ch: 7, lat: "aestimo", eng: "to esteem" },
        { ch: 7, lat: "invideo", eng: "to envy" },
        { ch: 7, lat: "puto", eng: "to consider" }
    ];

    // --- STATE VARIABLES ---
    let state = {
        activity: 'quiz', // 'quiz', 'macman', 'sort'
        pool: [],
        missed: [],
        index: 0,
        score: 0,
        settings: {
            mode: 'multiple',
            direction: 'lat-eng',
            chapter: 'all'
        },
        savedMissed: [], // Loaded from local storage
        
        // MacMan Specific
        mmWord: "",
        mmGuesses: [],
        mmWrongCount: 0,
        
        // Sort Specific
        sortItem: null
    };

    const screens = {
        start: document.getElementById('start-screen'),
        quiz: document.getElementById('quiz-screen'),
        macman: document.getElementById('macman-screen'),
        sort: document.getElementById('sort-screen'),
        result: document.getElementById('result-screen')
    };

    // --- PERSISTENCE ---
    const STORAGE_KEY = 'maclatin_save_v2';

    function loadData() {
        const json = localStorage.getItem(STORAGE_KEY);
        if (json) {
            try {
                const data = JSON.parse(json);
                state.savedMissed = data.missed || [];
                // Could also load scores here
                if (state.savedMissed.length > 0) {
                    document.getElementById('saved-data-notice').style.display = 'block';
                }
            } catch (e) {
                console.error("Save file corrupted");
            }
        }
    }

    function saveData() {
        // Merge current session missed with saved missed, avoiding duplicates
        const uniqueMissed = new Map();
        
        state.savedMissed.forEach(item => uniqueMissed.set(item.lat, item));
        state.missed.forEach(item => uniqueMissed.set(item.lat, item));
        
        const toSave = Array.from(uniqueMissed.values());
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            missed: toSave,
            lastSaved: new Date().getTime()
        }));
        
        state.savedMissed = toSave; // Update local state
    }

    // --- INITIALIZATION ---
    window.onload = function() {
        loadData();
    };

    // --- MENU LOGIC ---
    function setActivity(act) {
        state.activity = act;
        
        // Update Buttons
        document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(`btn-act-${act}`).classList.add('selected');

        // Show/Hide relevant settings
        const settingsDiv = document.getElementById('quiz-settings');
        if (act === 'quiz') {
            settingsDiv.style.display = 'block';
        } else {
            settingsDiv.style.display = 'none';
        }
    }

    function showScreen(name) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[name].classList.add('active');
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- GAME START ---
    function startGame(isReview) {
        // Capture Settings
        state.settings.chapter = document.getElementById('chapter-select').value;
        state.settings.mode = document.getElementById('mode-select').value;
        state.settings.direction = document.getElementById('direction-select').value;
        
        state.missed = []; // Reset current session missed
        state.score = 0;
        state.index = 0;

        // Build Pool
        let pool = [];
        if (isReview) {
            pool = [...state.savedMissed];
        } else {
            if (state.settings.chapter === 'all') {
                pool = [...VOCAB_DB];
            } else {
                pool = VOCAB_DB.filter(item => item.ch == state.settings.chapter);
            }
        }

        // Apply Activity Specific Filters
        if (state.activity === 'sort') {
            // Sort game only works with words that have a gender
            pool = pool.filter(item => item.gender);
        }

        if (pool.length === 0) {
            alert("No vocabulary available for this selection!");
            return;
        }

        state.pool = shuffle(pool);

        // Route to Game
        if (state.activity === 'quiz') startQuiz();
        else if (state.activity === 'macman') startMacMan();
        else if (state.activity === 'sort') startSort();
    }

    function reviewSavedMissed() {
        startGame(true);
    }

    function reviewMissedImmediately() {
        // This is called from the results screen to immediately retry failures
        // We temporarily treat them as "saved" for the sake of the pool generator
        state.savedMissed = [...state.missed]; 
        startGame(true);
    }

    function quitGame() {
        if(confirm("Quit to Menu? Progress will be saved.")) {
            saveData();
            showStartScreen();
            loadData(); // Refresh button visibility
        }
    }

    function showStartScreen() {
        showScreen('start');
    }

    // ==========================================
    // === ACTIVITY: QUIZ =======================
    // ==========================================
    function startQuiz() {
        showScreen('quiz');
        loadQuizQuestion();
    }

    function loadQuizQuestion() {
        if (state.index >= state.pool.length) {
            endGame();
            return;
        }
        
        const item = state.pool[state.index];
        const ui = {
            score: document.getElementById('quiz-score'),
            prog: document.getElementById('quiz-progress'),
            word: document.getElementById('quiz-word'),
            hint: document.getElementById('quiz-hint'),
            input: document.getElementById('quiz-input-area'),
            feed: document.getElementById('quiz-feedback')
        };

        ui.feed.innerHTML = "";
        ui.score.textContent = `Score: ${state.score}`;
        ui.prog.textContent = `${state.index + 1} / ${state.pool.length}`;

        if (state.settings.direction === 'lat-eng') {
            ui.word.textContent = item.lat;
            ui.hint.textContent = "(Latin)";
        } else {
            ui.word.textContent = item.eng;
            ui.hint.textContent = "(English)";
        }

        ui.input.innerHTML = '';
        if (state.settings.mode === 'multiple') {
            renderQuizMultiple(item, ui.input, ui.feed);
        } else {
            renderQuizType(item, ui.input, ui.feed);
        }
    }

    function renderQuizMultiple(correct, container, feedbackEl) {
        const grid = document.createElement('div');
        grid.className = 'choices-grid';

        let options = [correct];
        let distractors = VOCAB_DB.filter(i => i !== correct);
        shuffle(distractors);
        options = options.concat(distractors.slice(0, 5));
        shuffle(options);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = state.settings.direction === 'lat-eng' ? opt.eng : opt.lat;
            btn.onclick = () => {
                // Disable all
                const allBtns = grid.querySelectorAll('button');
                allBtns.forEach(b => b.disabled = true);
                
                if (opt === correct) {
                    state.score++;
                    btn.style.background = "#000";
                    btn.style.color = "#fff";
                    feedbackEl.innerHTML = "<span class='correct'>Correct!</span>";
                    setTimeout(() => { state.index++; loadQuizQuestion(); }, 800);
                } else {
                    state.missed.push(correct);
                    btn.style.textDecoration = "line-through";
                    // Find correct button to border
                    allBtns.forEach(b => {
                        const txt = state.settings.direction === 'lat-eng' ? correct.eng : correct.lat;
                        if(b.textContent === txt) b.style.border = "2px dashed #000";
                    });
                    const ans = state.settings.direction === 'lat-eng' ? correct.eng : correct.lat;
                    feedbackEl.innerHTML = `<span class='incorrect'>Incorrect.</span> Answer: ${ans}`;
                    setTimeout(() => { state.index++; loadQuizQuestion(); }, 2000);
                }
            };
            grid.appendChild(btn);
        });
        container.appendChild(grid);
    }

    function renderQuizType(correct, container, feedbackEl) {
        const input = document.createElement('input');
        input.type = "text";
        input.placeholder = "Type answer...";
        input.autocomplete = "off";
        
        const check = () => {
             const val = input.value.trim().toLowerCase();
             const ans = state.settings.direction === 'lat-eng' ? correct.eng : correct.lat;
             const normAns = ans.toLowerCase().replace(/^to\s+/, '').trim();
             
             if (val === normAns) {
                 state.score++;
                 feedbackEl.innerHTML = "<span class='correct'>Correct!</span>";
                 setTimeout(() => { state.index++; loadQuizQuestion(); }, 800);
             } else {
                 state.missed.push(correct);
                 feedbackEl.innerHTML = `<span class='incorrect'>Incorrect.</span> Answer: ${ans}`;
                 setTimeout(() => { state.index++; loadQuizQuestion(); }, 2000);
             }
        };

        input.onkeydown = (e) => { if(e.key === 'Enter' && input.value) check(); };
        const btn = document.createElement('button');
        btn.className = 'btn btn-block';
        btn.textContent = "Submit";
        btn.style.marginTop = "10px";
        btn.onclick = () => { if(input.value) check(); };

        container.appendChild(input);
        container.appendChild(btn);
        input.focus();
    }


    // ==========================================
    // === ACTIVITY: MACMAN (Hangman) ===========
    // ==========================================
    function startMacMan() {
        showScreen('macman');
        
        // Generate Keyboard
        const kb = document.getElementById('mm-keyboard');
        kb.innerHTML = '';
        const alpha = "abcdefghijklmnopqrstuvwxyz".split('');
        alpha.forEach(char => {
            const btn = document.createElement('button');
            btn.className = 'btn key-btn';
            btn.textContent = char;
            btn.id = `key-${char}`;
            btn.onclick = () => handleMacManGuess(char);
            kb.appendChild(btn);
        });

        loadMacManRound();
    }

    function loadMacManRound() {
        if (state.index >= state.pool.length) {
            endGame();
            return;
        }

        const item = state.pool[state.index];
        state.mmWord = item.lat.toLowerCase();
        state.mmGuesses = [];
        state.mmWrongCount = 0;
        
        // Render Initial State
        drawMacMan(0);
        updateMacManUI(item.eng);
        
        // Enable Keyboard
        document.querySelectorAll('.key-btn').forEach(b => {
            b.disabled = false;
            b.style.background = '#fff';
            b.style.color = '#000';
        });
        
        document.getElementById('mm-feedback').textContent = '';
    }

    function handleMacManGuess(char) {
        if (state.mmGuesses.includes(char)) return;
        state.mmGuesses.push(char);

        const btn = document.getElementById(`key-${char}`);
        btn.disabled = true;

        if (state.mmWord.includes(char)) {
            btn.style.background = '#000';
            btn.style.color = '#fff';
            checkMacManWin();
        } else {
            state.mmWrongCount++;
            btn.style.opacity = '0.5';
            drawMacMan(state.mmWrongCount);
            if (state.mmWrongCount >= 6) {
                // Loss
                state.missed.push(state.pool[state.index]);
                document.getElementById('mm-word').textContent = state.mmWord.split('').join(' ');
                document.getElementById('mm-feedback').innerHTML = "<span class='incorrect'>Oh no!</span>";
                setTimeout(() => { state.index++; loadMacManRound(); }, 2000);
            }
        }
        updateMacManUI();
    }

    function updateMacManUI(hintText) {
        // Display Word
        const display = state.mmWord.split('').map(char => {
            return state.mmGuesses.includes(char) ? char : "_";
        }).join(" ");
        document.getElementById('mm-word').textContent = display;
        
        if(hintText) document.getElementById('mm-hint').textContent = `Hint: ${hintText}`;
        document.getElementById('mm-score').textContent = `Score: ${state.score}`;
    }

    function checkMacManWin() {
        const isWin = state.mmWord.split('').every(c => state.mmGuesses.includes(c));
        if (isWin) {
            state.score++;
            document.getElementById('mm-feedback').innerHTML = "<span class='correct'>Got it!</span>";
            setTimeout(() => { state.index++; loadMacManRound(); }, 1000);
        }
    }

    function drawMacMan(stage) {
        const c = document.getElementById('macman-canvas');
        const ctx = c.getContext('2d');
        
        if (stage === 0) ctx.clearRect(0, 0, c.width, c.height);

        ctx.lineWidth = 3;
        ctx.strokeStyle = '#000';
        ctx.beginPath();

        // 1: Base & Pole
        if (stage >= 1) {
            ctx.moveTo(20, 130); ctx.lineTo(130, 130); // Base
            ctx.moveTo(40, 130); ctx.lineTo(40, 20);   // Pole
            ctx.lineTo(100, 20); ctx.lineTo(100, 40);  // Top & Rope
        }
        // 2: Head
        if (stage >= 2) {
            ctx.moveTo(110, 50);
            ctx.arc(100, 50, 10, 0, Math.PI * 2); 
        }
        // 3: Body
        if (stage >= 3) {
            ctx.moveTo(100, 60); ctx.lineTo(100, 100);
        }
        // 4: Left Arm
        if (stage >= 4) {
            ctx.moveTo(100, 70); ctx.lineTo(80, 90);
        }
        // 5: Right Arm
        if (stage >= 5) {
            ctx.moveTo(100, 70); ctx.lineTo(120, 90);
        }
        // 6: Legs (Final)
        if (stage >= 6) {
            ctx.moveTo(100, 100); ctx.lineTo(85, 125); // L Leg
            ctx.moveTo(100, 100); ctx.lineTo(115, 125); // R Leg
            // Draw "X" eyes for fun retro error feel
            ctx.font = "12px sans-serif";
            ctx.fillText("x x", 92, 53);
        }
        ctx.stroke();
    }


    // ==========================================
    // === ACTIVITY: GENDER SORT ================
    // ==========================================
    function startSort() {
        showScreen('sort');
        loadSortRound();
    }

    function loadSortRound() {
        if (state.index >= state.pool.length) {
            endGame();
            return;
        }

        const item = state.pool[state.index];
        state.sortItem = item;
        
        document.getElementById('sort-word').textContent = item.lat;
        document.getElementById('sort-def').textContent = item.eng;
        document.getElementById('sort-score').textContent = `Score: ${state.score}`;
        document.getElementById('sort-feedback').textContent = '';
        
        // Enable buttons
        document.querySelectorAll('.folder-btn').forEach(b => {
            b.disabled = false;
            b.style.background = '#fff';
            b.style.color = '#000';
        });
    }

    function checkSort(selection) {
        // Disable buttons
        document.querySelectorAll('.folder-btn').forEach(b => b.disabled = true);
        
        const correct = state.sortItem.gender.toLowerCase();
        
        if (selection === correct) {
            state.score++;
            document.getElementById('sort-feedback').innerHTML = "<span class='correct'>Correct!</span>";
            setTimeout(() => { state.index++; loadSortRound(); }, 600);
        } else {
            state.missed.push(state.sortItem);
            document.getElementById('sort-feedback').innerHTML = `<span class='incorrect'>Oops.</span> It was ${correct.toUpperCase()}`;
            setTimeout(() => { state.index++; loadSortRound(); }, 1500);
        }
    }


    // ==========================================
    // === END GAME & RESULTS ===================
    // ==========================================
    function endGame() {
        saveData(); // Save stats/missed
        showScreen('result');
        
        const percentage = Math.round((state.score / state.pool.length) * 100);
        document.getElementById('final-score').textContent = `${percentage}%`;

        const msg = document.getElementById('result-message');
        if (percentage === 100) msg.textContent = "Perfect Score!";
        else if (percentage >= 80) msg.textContent = "Great Job!";
        else msg.textContent = "Review the list below.";

        // Populate List
        const list = document.getElementById('log-list');
        list.innerHTML = '';
        
        const container = document.getElementById('missed-container');
        if (state.missed.length > 0) {
            container.style.display = 'block';
            state.missed.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${item.lat}</span> <span>${item.eng}</span>`;
                list.appendChild(li);
            });
        } else {
            container.style.display = 'none';
        }
    }

</script>
</body>
</html>
