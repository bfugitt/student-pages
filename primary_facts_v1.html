<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primary Fact Builder</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom styles for the input box and flash effects */
        #answerInput {
            transition: all 0.1s ease-in-out;
        }
        .correct-flash {
            border-color: #10B981 !important; /* Green 500 */
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.7) !important;
        }
        .incorrect-flash {
            border-color: #EF4444 !important; /* Red 500 */
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.7) !important;
        }
        /* Style for operation and addend checkboxes */
        .custom-checkbox {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
            width: 1.5em;
            height: 1.5em;
            border: 2px solid #ccc;
            border-radius: 0.35em;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }
        .custom-checkbox:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .custom-checkbox:checked::before {
            content: "✓";
            color: white;
            font-size: 1.1em;
            font-weight: 900;
        }
        /* Custom slider track/thumb styling */
        input[type=range]::-webkit-slider-runnable-track {
            background: #9ca3af;
            height: 8px;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5;
            margin-top: -6px;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
            cursor: grab;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="appContainer" class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-xl transition-all duration-300">
        <!-- Title and Logo -->
        <h1 class="text-3xl md:text-4xl font-extrabold text-pink-600 text-center mb-6">
            <span class="inline-block transform -rotate-6 text-yellow-500 mr-2">🎯</span>
            Primary Fact Builder
        </h1>
        <p class="text-center text-gray-500 mb-8">
            Select specific numbers for targeted Addition and Subtraction practice.
        </p>

        <!-- Screen Container -->
        <div id="screenContainer">
            <!-- Content will be injected here by JavaScript -->
        </div>
    </div>

    <script>
        // --- STATE & CONFIGURATION ---
        let problemCount = 20; // Default number of problems
        let selectedAddends = Array.from({ length: 13 }, (_, i) => i); // Default 0-12
        let selectedOps = ['+', '-']; // Default Addition and Subtraction
        let problems = []; // Array to hold pre-generated problems
        let currentProblemIndex = 0;
        let score = 0;
        let attempted = 0;
        let gameState = 'SETUP'; // SETUP | GAME | RESULTS

        // NEW TIMER & MC STATE
        const GAME_DURATION = 60; // seconds
        let timer = 0;
        let gameInterval = null;
        let isMultipleChoice = false; 

        const ADDEND_RANGE = 12;
        const screenContainer = document.getElementById('screenContainer');
        
        // --- SOUND EFFECTS ---
        const correctSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" } }).toDestination();
        const incorrectSynth = new Tone.NoiseSynth({
            noise: { type: "pink" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
        }).toDestination();
        const successSynth = new Tone.PolySynth(Tone.AMSynth).toDestination();

        function playCorrectSound() { correctSynth.triggerAttackRelease(["C5", "E5"], "8n"); }
        function playIncorrectSound() { incorrectSynth.triggerAttackRelease("16n"); }
        function playSuccessSound() { successSynth.triggerAttackRelease(["C4", "E4", "G4"], "0.5"); }

        // --- UTILITY FUNCTIONS ---

        /** Shuffles an array in place using the Fisher-Yates algorithm. */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        /**
         * Generates an array of four answer choices, including the correct one.
         */
        function generateChoices(correctAnswer) {
            const choices = new Set();
            choices.add(correctAnswer);

            while (choices.size < 4) {
                let distractor;
                // Generate a distractor within a reasonable range
                const deviation = Math.floor(Math.random() * 9) - 4; // -4 to 4 range
                distractor = correctAnswer + deviation;

                if (distractor >= 0 && !choices.has(distractor)) {
                    // Ensure distractor is not too far off, but diverse enough
                    if (Math.abs(distractor - correctAnswer) > 0 && Math.abs(distractor - correctAnswer) < 10) {
                         choices.add(distractor);
                    }
                }
                
                // Backup for small numbers to ensure 4 choices
                if (choices.size < 4 && correctAnswer <= 5) {
                     distractor = Math.floor(Math.random() * 11); // 0-10
                     if (distractor >= 0 && !choices.has(distractor)) choices.add(distractor);
                }
            }

            const choicesArray = Array.from(choices);
            // Shuffle the array
            for (let i = choicesArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [choicesArray[i], choicesArray[j]] = [choicesArray[j], choicesArray[i]];
            }

            return choicesArray;
        }

        // Timer Display Utility
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = `${timer}s`;
                if (timer <= 10) {
                    timerDisplay.classList.add('text-red-700', 'animate-pulse');
                } else {
                    timerDisplay.classList.remove('text-red-700', 'animate-pulse');
                }
            }
        }

        // Simple modal implementation (to replace alert)
        function showModal(title, message, callback) {
            const modalHTML = `
                <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                        <h3 class="text-xl font-bold text-red-600 mb-4">${title}</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="document.getElementById('customModal').remove(); ${callback ? 'callback()' : ''}"
                                    class="py-2 px-4 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition duration-150">
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // --- PROBLEM GENERATION LOGIC ---

        /**
         * Generates all possible addition and subtraction facts based on selected addends.
         */
        function generateAllPossibleFacts(addends, ops) {
            const allFacts = new Set();
            
            // 1. Generate Addition Facts (A + B = C)
            if (ops.includes('+')) {
                for (let i = 0; i < addends.length; i++) {
                    const A = addends[i];
                    for (let j = 0; j < addends.length; j++) {
                        const B = addends[j];
                        const C = A + B;
                        // Problem format: { problemText: "A + B =", answer: C, op: '+' }
                        allFacts.add(JSON.stringify({ problemText: `${A} + ${B} =`, answer: C, op: '+' }));
                    }
                }
            }
            
            // 2. Generate Subtraction Facts (C - A = B and C - B = A)
            if (ops.includes('-')) {
                for (let i = 0; i < addends.length; i++) {
                    const B = addends[i];
                    for (let j = 0; j < addends.length; j++) {
                        const A = addends[j];
                        const C = A + B; // The minuend (C) is the sum of the two selected addends
                        
                        // C - A = B
                        allFacts.add(JSON.stringify({ problemText: `${C} - ${A} =`, answer: B, op: '-' }));
                        
                        // C - B = A (Only add if A and B are different to avoid duplicates, e.g., 10-5=5)
                        if (A !== B) {
                            allFacts.add(JSON.stringify({ problemText: `${C} - ${B} =`, answer: A, op: '-' }));
                        }
                    }
                }
            }

            // Convert back to objects, shuffle, and return
            let factArray = Array.from(allFacts).map(json => JSON.parse(json));
            shuffleArray(factArray);
            return factArray;
        }

        /**
         * The primary start function called from the setup screen.
         */
        window.startPractice = function() {
            // Use a simple custom message box instead of alert
            if (selectedAddends.length === 0) {
                showModal('Selection Required', 'Please select at least one Addend to practice.', () => {});
                return;
            }
            if (selectedOps.length === 0) {
                showModal('Selection Required', 'Please select at least one Operation to practice.', () => {});
                return;
            }

            // Generate all possible facts based on the current selection
            let allFacts = generateAllPossibleFacts(selectedAddends, selectedOps);
            
            // Trim the facts array to the desired problem count
            problems = allFacts.slice(0, problemCount);
            
            // If there are fewer than the requested number of unique problems, loop the list
            if (allFacts.length < problemCount) {
                for (let i = allFacts.length; i < problemCount; i++) {
                    problems.push(allFacts[i % allFacts.length]);
                }
                shuffleArray(problems); // Shuffle again after looping
            }

            currentProblemIndex = 0;
            score = 0;
            attempted = 0;
            
            // TIMER START LOGIC
            if (gameInterval) clearInterval(gameInterval);
            timer = GAME_DURATION;
            
            gameState = 'GAME';
            renderGame();
            nextProblem();

            gameInterval = setInterval(() => {
                timer--;
                updateTimerDisplay();
                if (timer <= 0) {
                    clearInterval(gameInterval);
                    // Ensure currentProblemIndex is set to end of array to trigger results
                    currentProblemIndex = problems.length; 
                    renderResults();
                }
            }, 1000);
        }

        // --- UI UPDATE HANDLERS ---

        /** Updates the problem count state from the slider. */
        window.updateProblemCount = function(value) {
            problemCount = parseInt(value, 10);
            document.getElementById('problemCountDisplay').textContent = problemCount;
        }
        
        /**
         * Function to toggle the multiple choice state from the UI checkbox.
         */
        window.toggleMultipleChoice = function(checked) {
            isMultipleChoice = checked;
        }

        /** Updates the selected operations state from checkboxes. */
        window.updateSelectedOps = function(op, checked) {
            if (checked) {
                if (!selectedOps.includes(op)) selectedOps.push(op);
            } else {
                selectedOps = selectedOps.filter(o => o !== op);
            }
        }

        /** Updates the selected addends state from checkboxes. */
        window.updateSelectedAddends = function(addend, checked) {
            const num = parseInt(addend, 10);
            if (checked) {
                if (!selectedAddends.includes(num)) selectedAddends.push(num);
            } else {
                selectedAddends = selectedAddends.filter(n => n !== num);
            }
            selectedAddends.sort((a, b) => a - b);
        }

        /** Checks/unchecks all addend boxes. */
        window.toggleAllAddends = function(checked) {
            selectedAddends = [];
            for (let i = 0; i <= ADDEND_RANGE; i++) {
                const checkbox = document.getElementById(`addend-${i}`);
                checkbox.checked = checked;
                if (checked) {
                    selectedAddends.push(i);
                }
            }
            selectedAddends.sort((a, b) => a - b);
        }

        // --- UI RENDERING FUNCTIONS ---

        /** Renders the setup screen. */
        function renderSetupScreen() {
            // Addend Checkboxes (0-12)
            let addendBoxes = '';
            for (let i = 0; i <= ADDEND_RANGE; i++) {
                addendBoxes += `
                    <label class="flex items-center space-x-1 p-2 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 justify-center">
                        <input type="checkbox" id="addend-${i}" 
                               class="custom-checkbox"
                               ${selectedAddends.includes(i) ? 'checked' : ''} 
                               onchange="updateSelectedAddends(${i}, this.checked)">
                        <span class="text-lg font-bold text-gray-700">${i}</span>
                    </label>
                `;
            }

            // Operation Checkboxes
            const ops = [
                { op: '+', label: 'Addition', color: 'green' },
                { op: '-', label: 'Subtraction', color: 'blue' }
            ];
            let opBoxes = ops.map(item => `
                <label class="flex items-center space-x-2 bg-white p-3 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50 shadow-sm">
                    <input type="checkbox" id="op-${item.op}"
                           class="custom-checkbox"
                           ${selectedOps.includes(item.op) ? 'checked' : ''}
                           onchange="updateSelectedOps('${item.op}', this.checked)">
                    <span class="text-xl font-extrabold text-${item.color}-600">${item.op} ${item.label}</span>
                </label>
            `).join('');

            screenContainer.innerHTML = `
                <!-- Problem Count Slider -->
                <div class="p-4 rounded-xl bg-indigo-50 border border-indigo-200 mb-6 shadow-md">
                    <label class="text-lg font-extrabold text-gray-800 mb-3 block">
                        Number of Problems: 
                        <span id="problemCountDisplay" class="text-indigo-600">${problemCount}</span>
                    </label>
                    <input type="range" id="problemCountSlider" min="10" max="50" step="10" 
                           value="${problemCount}" 
                           oninput="updateProblemCount(this.value)"
                           class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-sm text-gray-600 mt-1">
                        <span>10</span>
                        <span>50</span>
                    </div>
                </div>

                <!-- Operation Selection -->
                <div class="p-4 rounded-xl bg-yellow-50 border border-yellow-200 mb-6 shadow-md">
                    <label class="text-lg font-extrabold text-gray-800 mb-3 block">Select Operations:</label>
                    <div class="flex space-x-4 justify-around">
                        ${opBoxes}
                    </div>
                </div>

                <!-- Multiple Choice Toggle -->
                <div class="flex items-center justify-between p-4 mb-6 rounded-xl bg-gray-100 shadow-inner">
                    <label for="mc-toggle" class="text-lg font-semibold text-gray-700">Use Multiple Choice (Easier Input)?</label>
                    <input type="checkbox" id="mc-toggle" class="custom-checkbox" ${isMultipleChoice ? 'checked' : ''} onchange="toggleMultipleChoice(this.checked)">
                </div>

                <!-- Addend Selection (0-12) -->
                <div class="p-4 rounded-xl bg-pink-50 border border-pink-200 mb-8 shadow-md">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-lg font-extrabold text-gray-800">Select Addends (0-12):</label>
                        <button onclick="toggleAllAddends(!document.getElementById('addend-0').checked)" 
                                class="text-sm px-3 py-1 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded-lg transition duration-150 shadow-sm">
                            Toggle All
                        </button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 md:gap-2 text-center">
                        ${addendBoxes}
                    </div>
                    <p class="text-xs text-gray-600 mt-2 italic">Example: Selecting only '5' results in 5+5=10, 10-5=5 problems.</p>
                </div>

                <!-- Start Button -->
                <button onclick="startPractice()"
                        class="w-full py-4 bg-pink-500 hover:bg-pink-600 text-white font-extrabold text-xl rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-pink-300">
                    Start Practice
                </button>
            `;
            gameState = 'SETUP';
        }

        /** Renders the main game screen. */
        function renderGame() {
            const total = problems.length;

            // Determine input element based on isMultipleChoice state
            let inputElement;
            let helperText;

            if (isMultipleChoice) {
                inputElement = `<div id="choicesContainer" class="grid grid-cols-2 gap-4"></div>`;
                helperText = '<p class="text-sm text-gray-500 mt-2 text-center">Click the correct answer!</p>';
            } else {
                inputElement = `
                    <input type="number" id="answerInput"
                           class="w-full p-4 text-center text-4xl font-extrabold text-gray-800 border-4 border-pink-300 rounded-xl focus:ring-4 focus:ring-pink-400 focus:border-pink-500 transition-all duration-200"
                           placeholder="?" autofocus>
                `;
                helperText = '<p class="text-sm text-gray-500 mt-2 text-center">Correct answers submit automatically. Press ENTER to check an incorrect answer.</p>';
            }

            screenContainer.innerHTML = `
                <div class="flex justify-between items-center mb-6 text-lg font-medium text-gray-600">
                    <div>Problem: <span id="currentProblemNumber" class="font-bold text-pink-700">${currentProblemIndex + 1}</span> / ${total}</div>
                </div>

                <!-- Score, Timer, Attempts Display -->
                <div class="flex justify-between items-center mb-8 p-4 bg-gray-100 rounded-lg shadow-inner">
                    <div id="scoreDisplay" class="text-xl md:text-2xl font-bold text-green-600">Score: 0</div>
                    <div id="timerDisplay" class="text-2xl md:text-3xl font-extrabold text-red-500">${GAME_DURATION}s</div>
                    <div id="attemptsDisplay" class="text-xl md:text-2xl font-extrabold text-gray-700">Attempted: 0</div>
                </div>

                <!-- Problem Area -->
                <div class="flex flex-col items-center justify-center h-40 bg-pink-50 rounded-xl shadow-md p-6 mb-8">
                    <p id="problemText" class="text-6xl font-extrabold text-pink-800 mb-4 select-none">
                        <!-- Problem text goes here -->
                    </p>
                </div>

                <!-- Answer Input or Choices -->
                ${inputElement}
                
                ${helperText}

                <!-- End Practice button -->
                <button onclick="endGameEarly()" class="mt-6 w-full py-2 bg-red-400 hover:bg-red-500 text-white font-bold rounded-xl transition duration-150 shadow-md">
                    End Practice
                </button>
            `;
            setupGameListeners();
        }

        /** Renders the results screen. */
        function renderResults() {
            // Clear interval if it's still running (e.g., if endGameEarly was called or timer ran out)
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = null;

            const totalProblems = problems.length;
            const accuracy = attempted > 0 ? ((score / attempted) * 100).toFixed(0) : 0;
            const perfectScore = score === totalProblems && currentProblemIndex === totalProblems; // Perfect score only if all problems were shown and correct

            // Play the success sound if they got a good score (>= 80% accuracy)
            if (score > 0 && accuracy >= 80) {
                playSuccessSound();
            }

            screenContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-center mb-6 ${accuracy >= 80 ? 'text-green-600' : 'text-pink-600'}">
                    ${accuracy >= 80 ? 'GREAT WORK! ⭐' : 'Time to review those facts!'}
                </h2>

                <div class="p-6 bg-gray-100 rounded-xl shadow-inner mb-8">
                    <p class="text-xl font-bold text-green-600 mb-2">Correct Answers: ${score}</p>
                    <p class="text-xl font-bold text-gray-800 mb-2">Total Attempted: ${attempted}</p>
                    <hr class="my-4 border-gray-300">
                    <p class="text-2xl font-extrabold text-indigo-700">Accuracy: ${accuracy}%</p>
                </div>

                <div class="text-center mb-6">
                    <p class="text-lg text-gray-700">Practice complete!</p>
                </div>

                <div class="flex space-x-4">
                    <button onclick="startPractice()"
                            class="w-1/2 py-3 bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-pink-300">
                        Repeat This Practice
                    </button>

                    <button onclick="renderSetupScreen()"
                            class="w-1/2 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        New Fact Selection
                    </button>
                </div>
            `;
            gameState = 'RESULTS';
        }

        /** Sets up input event listeners (only for non-MC mode). */
        function setupGameListeners() {
            if (isMultipleChoice) return; // Skip listeners in MC mode

            const input = document.getElementById('answerInput');
            if (input) {
                // Auto-submit on correct answer + length match
                input.addEventListener('input', (e) => {
                    if (gameState !== 'GAME') return;
                    const userAnswer = e.target.value;
                    const correctAnswer = problems[currentProblemIndex]?.answer.toString();

                    if (userAnswer.length === correctAnswer.length && parseInt(userAnswer, 10) === problems[currentProblemIndex].answer) {
                        checkAnswer(userAnswer);
                    }
                });

                // Explicit check/feedback on Enter press (used for incorrect or incomplete answers)
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        checkAnswer(input.value);
                    }
                });
            }
        }

        /** Moves to the next problem or ends the game. */
        function nextProblem() {
            if (timer <= 0) return; // Stop generating if time is up

            currentProblemIndex++;
            // Note: Since this is timed, the game doesn't stop just because the pre-generated list runs out.
            // It will simply cycle through the problems list (which was already repeated if necessary in startPractice)
            
            const problem = problems[currentProblemIndex % problems.length];
            
            document.getElementById('currentProblemNumber').textContent = (currentProblemIndex % problems.length) + 1; // Display current index within the problem list
            document.getElementById('problemText').textContent = problem.problemText;
            
            if (isMultipleChoice) {
                const choices = generateChoices(problem.answer);
                const choicesContainer = document.getElementById('choicesContainer');
                let buttonsHTML = '';
                choices.forEach(choice => {
                    // Use checkAnswer directly with the choice value
                    buttonsHTML += `
                        <button onclick="checkAnswer(${choice})"
                                class="py-4 text-3xl font-bold bg-pink-500 hover:bg-pink-600 text-white rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-105">
                            ${choice}
                        </button>
                    `;
                });
                choicesContainer.innerHTML = buttonsHTML;
            } else {
                const input = document.getElementById('answerInput');
                input.value = '';
                input.focus();
            }
        }

        /** Checks the user's answer. */
        function checkAnswer(inputValue) {
            if (gameState !== 'GAME' || timer <= 0) return;

            const userAnswer = parseInt(inputValue, 10);
            const currentProblem = problems[currentProblemIndex % problems.length];
            const isCorrect = userAnswer === currentProblem.answer;

            attempted++;

            const input = document.getElementById('answerInput');
            
            if (isCorrect) {
                playCorrectSound();
                score++;
                document.getElementById('scoreDisplay').textContent = `Score: ${score}`;

                // Only apply flash effect to the input box in non-MC mode
                if (input && !isMultipleChoice) {
                    input.classList.add('correct-flash');
                    setTimeout(() => input.classList.remove('correct-flash'), 200);
                }
                
                // Delay next problem slightly if in MC mode for better feedback visibility
                setTimeout(nextProblem, isMultipleChoice ? 200 : 0);
            } else {
                playIncorrectSound();
                
                // Only apply flash effect and clear input in non-MC mode
                if (input && !isMultipleChoice) {
                    input.classList.add('incorrect-flash');
                    setTimeout(() => {
                        input.classList.remove('incorrect-flash');
                        input.value = '';
                        input.focus();
                    }, 500);
                } else if (isMultipleChoice) {
                    // In MC mode, just move to the next problem immediately on wrong click
                    setTimeout(nextProblem, 200); 
                }
            }
            document.getElementById('attemptsDisplay').textContent = `Attempted: ${attempted}`;
        }

        /** Exits the practice session early. */
        window.endGameEarly = function() {
            if (gameInterval) clearInterval(gameInterval);
            renderResults();
        }

        // --- INITIALIZATION ---
        window.onload = renderSetupScreen;

    </script>
</body>
</html>
